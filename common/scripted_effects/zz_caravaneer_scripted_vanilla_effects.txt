@fleet1dealdecay = 3600
@fleet2dealdecay = 3600
@fleet3dealdecay = 3600

cara_generate_deal1 = {
	if = {
		# repeat existing price for 1 year, otherwise refresh flag
		limit = {
			NOR = {
				has_country_flag = fleet1dealcost1 # 1 specialist
				has_country_flag = fleet1dealcost2 # 1200 alloys
				has_country_flag = fleet1dealcost3 # 500 unity
				has_country_flag = fleet1dealcost4 # 6 months society research
				has_country_flag = fleet1dealcost5 # science ship
				has_country_flag = fleet1dealcost6 # 1 pops
				has_country_flag = fleet1dealcostmod1 # 2000 minerals
				has_country_flag = fleet1dealcostmod2 # 60 rare crystals
				has_country_flag = fleet1dealcostmod3 # level 5 scientist
			}
		}
		remove_country_flag = fleet1dealcost1
		remove_country_flag = fleet1dealcost2
		remove_country_flag = fleet1dealcost3
		remove_country_flag = fleet1dealcost4
		remove_country_flag = fleet1dealcost5
		remove_country_flag = fleet1dealcost6
		remove_country_flag = fleet1dealcostmod1
		remove_country_flag = fleet1dealcostmod2
		remove_country_flag = fleet1dealcostmod3
		random_list = {
			1 = {
				modifier = {
					factor = 0.25
					is_egalitarian = yes
				}
				modifier = {
					factor = 0.5
					NOT = {
						count_owned_pop = {
							limit = {
								OR = {
									is_pop_category = specialist
									is_pop_category = complex_drone
								}
							}
							count >= 20
						}
					}
				}
				modifier = {
					factor = 0
					NOT = {
						count_owned_pop = {
							limit = {
								OR = {
									is_pop_category = specialist
									is_pop_category = complex_drone
								}
							}
							count >= 2
						}
					}
				}
				modifier = {
					factor = 0
					is_hive_empire = yes
				}
				set_timed_country_flag = { flag = fleet1dealcost1 days = @fleet1dealdecay }
			}
			1 = {
				modifier = {
					factor = 0.5
					has_monthly_income = { resource = alloys value < 24 }
				}
				modifier = {
					factor = 0
					is_at_war = yes
				}
				set_timed_country_flag = { flag = fleet1dealcost2 days = @fleet1dealdecay }
			}
			1 = { set_timed_country_flag = { flag = fleet1dealcost3 days = @fleet1dealdecay } }
			1 = {
				modifier = {
					factor = 0
					has_modifier = 6monthsocietycost
				}
				set_timed_country_flag = { flag = fleet1dealcost4 days = @fleet1dealdecay }
			}
			1 = { set_timed_country_flag = { flag = fleet1dealcost5 days = @fleet1dealdecay } }
			0 = {
				modifier = {
					add = 1
					is_hive_empire = yes
				}
				modifier = {
					add = 1
					is_gestalt = no
					count_owned_pop = {
						limit = {
							OR = {
								is_unemployed = yes
								is_pop_category = slave
								is_pop_category = criminal
								is_pop_category = purge
							}
						}
						count >= 2
					}
				}
				modifier = {
					factor = 0.25
					is_egalitarian = yes
				}
				set_timed_country_flag = { flag = fleet1dealcost6 days = @fleet1dealdecay }
			}
			1 = { set_timed_country_flag = { flag = fleet1dealcostmod1 days = @fleet1dealdecay } }
			1 = {
				set_timed_country_flag = { flag = fleet1dealcostmod2 days = @fleet1dealdecay }
				modifier = {
					factor = 0
					NOT = {
						resource_stockpile_compare = {
							resource = rare_crystals
							value > 60
						}
					}
				}
			}
			1 = {
				set_timed_country_flag = { flag = fleet1dealcostmod3 days = @fleet1dealdecay }
				modifier = {
					factor = 0
					NOT = {
						any_owned_leader = {
							leader_class = scientist
							has_skill > 4
							NOT = { has_trait = "leader_trait_curator" }
						}
					}
				}
				modifier = {
					factor = 0.25
					is_egalitarian = yes
				}
			}
		}
	}
	# PRODUCT
	if = {
		# repeat existing product for 1 year, otherwise refresh flag
		limit = {
			NOR = {
				has_country_flag = fleet1dealproduct1 # Bunkbeds
				has_country_flag = fleet1dealproduct2 # Tupperware
				has_country_flag = fleet1dealproduct3 # Atmospheric Deodorizer
				has_country_flag = fleet1dealproduct4 # Consumer Goods
				has_country_flag = fleet1dealproduct5 # Trade Value
				has_country_flag = fleet1dealproduct6 # Spawning Pool Stimulants
				has_country_flag = fleet1dealproduct7 # Energy
				has_country_flag = fleet1dealproductmod1 # Food
				has_country_flag = fleet1dealproductmod2 # Epigenetic Triggers
				has_country_flag = fleet1dealproductmod3 # Precursor Artifacts
				has_country_flag = fleet1dealproductmod4 # Volatile Motes
				has_country_flag = fleet1dealproductmod5 # Dark Matter
				has_country_flag = fleet1dealproductmod6 # Worker Production
				has_country_flag = fleet1dealproductmod7 # Minor Artifacts
				has_country_flag = fleet1dealproductmod8 # Envoys
			}
		}
		remove_country_flag = fleet1dealproduct1
		remove_country_flag = fleet1dealproduct2
		remove_country_flag = fleet1dealproduct3
		remove_country_flag = fleet1dealproduct4
		remove_country_flag = fleet1dealproduct5
		remove_country_flag = fleet1dealproduct6
		remove_country_flag = fleet1dealproduct7
		remove_country_flag = fleet1dealproductmod1
		remove_country_flag = fleet1dealproductmod2
		remove_country_flag = fleet1dealproductmod3
		remove_country_flag = fleet1dealproductmod4
		remove_country_flag = fleet1dealproductmod5
		remove_country_flag = fleet1dealproductmod6
		remove_country_flag = fleet1dealproductmod7
		remove_country_flag = fleet1dealproductmod8
		random_list = {

			# Bunk beds
			1 = {
				modifier = {
					factor = 2
					any_owned_planet = { free_housing < 0 }
				}
				modifier = {
					factor = 0.5
					NOT = {
						any_owned_planet = { free_housing < 10 }
					}
				}
				modifier = {
					factor = 0.1
					OR = {
						has_country_flag = bunkbeds_ready
						any_owned_planet = { has_modifier = bunkbeds_deployed }
					}
				}
				set_timed_country_flag = { flag = fleet1dealproduct1 days = @fleet1dealdecay }
			}

			# Tupperware
			1 = {
				modifier = {
					factor = 0.5
					has_monthly_income = { resource = food value >= 45 }
				}
				modifier = {
					factor = 1.5
					has_monthly_income = { resource = food value <= 15 }
				}
				modifier = {
					factor = 1.5
					has_monthly_income = { resource = food value <= 1 }
				}
				modifier = {
					factor = 0.1
					OR = {
						has_country_flag = tupperware_ready
						any_owned_planet = { has_modifier = tupperware_deployed }
					}
				}
				modifier = {
					factor = 0
					country_uses_food = no
				}
				set_timed_country_flag = { flag = fleet1dealproduct2 days = @fleet1dealdecay }
			}

			# Atmospheric Deodorizer
			1 = {
				modifier = {
					factor = 0.1
					OR = {
						has_country_flag = atmospheric_deodorizer_ready
						any_owned_planet = { has_modifier = atmospheric_deodorizer_deployed }
					}
				}
				modifier = {
					factor = 0
					is_gestalt = yes
				}
				set_timed_country_flag = { flag = fleet1dealproduct3 days = @fleet1dealdecay }
			}

			# Consumer Goods
			1 = {
				modifier = {
					factor = 0.5
					has_monthly_income = { resource = consumer_goods value >= 24 }
				}
				modifier = {
					factor = 1.5
					has_monthly_income = { resource = consumer_goods value <= 8 }
				}
				modifier = {
					factor = 1.5
					has_monthly_income = { resource = consumer_goods value <= 1 }
				}
				modifier = {
					factor = 0.1
					has_country_flag = fleet1dealcost2
				}
				modifier = {
					factor = 0
					country_uses_consumer_goods = no
				}
				modifier = {
					factor = 0.5
					has_ethic = ethic_gestalt_consciousness
					NOT = { has_civic = civic_machine_servitor }
					NOT = { has_civic = civic_machine_consciousness }
				}
				set_timed_country_flag = { flag = fleet1dealproduct4 days = @fleet1dealdecay }
			}
			# Trade Value
			1 = {
				modifier = {
					factor = 0
					OR = {
						is_gestalt = yes
						has_modifier = vengralian_sales_contingent
					}
				}
				modifier = {
					factor = 1.5
					OR = {
						is_megacorp = yes
						has_valid_civic = civic_corporate_dominion
						has_valid_civic = civic_merchant_guilds
					}
				}
				set_timed_country_flag = { flag = fleet1dealproduct5 days = @fleet1dealdecay }
			}

			# Spawn Pool Stimulants
			1 = {
				modifier = {
					factor = 0
					NOT = { has_authority = auth_hive_mind }
				}
				modifier = {
					factor = 0.5
					NOT = {
						any_owned_planet = {
							OR = {
								free_jobs >= 2
								free_district_slots >= 1
							}
						}
					}
				}
				modifier = {
					factor = 1.5
					any_owned_planet = {
						OR = {
							free_jobs >= 2
							free_district_slots >= 1
						}
					}
				}
				modifier = {
					factor = 1.5
					any_owned_planet = {
						OR = {
							free_jobs >= 5
							free_district_slots >= 2
						}
					}
				}
				modifier = {
					factor = 0
					has_modifier = spawn_pool_stimulants
				}
				set_timed_country_flag = { flag = fleet1dealproduct6 days = @fleet1dealdecay }
			}

			# Energy
			0 = {
				modifier = {
					add = 1
					has_ethic = ethic_gestalt_consciousness
				}
				modifier = {
					factor = 0.5
					has_monthly_income = { resource = energy value >= 45 }
				}
				modifier = {
					factor = 1.5
					has_monthly_income = { resource = energy value <= 15 }
				}
				modifier = {
					factor = 1.5
					has_monthly_income = { resource = energy value <= 1 }
				}
				modifier = {
					factor = 0.1
					has_country_flag = fleet1dealcost2
				}
				modifier = {
					factor = 5
					has_ethic = ethic_gestalt_consciousness
					has_country_flag = fleet1dealcost6
				}
				set_timed_country_flag = { flag = fleet1dealproduct7 days = @fleet1dealdecay }
			}
			
			# Food
			1 = {
				modifier = {
					factor = 0.5
					has_monthly_income = { resource = food value >= 45 }
				}
				modifier = {
					factor = 1.5
					has_monthly_income = { resource = food value <= 15 }
				}
				modifier = {
					factor = 1.5
					has_monthly_income = { resource = food value <= 1 }
				}
				modifier = {
					factor = 0.1
					has_country_flag = fleet1dealcost2
				}
				modifier = {
					factor = 0
					country_uses_food = no
				}
				set_timed_country_flag = { flag = fleet1dealproductmod1 days = @fleet1dealdecay }
			}
			
			# Epigenetic Triggers
			1 = {
				modifier = {
					factor = 0.25
					is_xenophobe = yes
				}
				modifier = {
					factor = 1.5
					OR = {
						is_xenophile = yes
						has_civic = civic_machine_servitor
						has_civic = civic_machine_assimilator
						has_civic = civic_machine_consciousness
					}
				}
				modifier = {
					factor = 0
					has_authority = auth_machine_intelligence
					NOT = { has_civic = civic_machine_servitor }
					NOT = { has_civic = civic_machine_assimilator }
					NOT = { has_civic = civic_machine_consciousness }
				}
				modifier = {
					factor = 0.1
					NOR = {
						has_country_flag = found_presapients
						any_planet_within_border = {
							any_owned_pop = { is_sapient = no }
						}			
					}
				}
				modifier = {
					factor = 0
					has_technology = tech_epigenetic_triggers
				}
				set_timed_country_flag = { flag = fleet1dealproductmod2 days = @fleet1dealdecay }
			}
			
			# Precursor Artifacts
			0 = {
				modifier = {
					add = 1
					have_active_precursor_chain = yes
					NOT = { has_country_flag = fleet1_precursor }
				}
				modifier = {
					factor = 1.5
					OR = {
						has_country_flag = fleet1dealcost4
						has_country_flag = fleet1dealcost5
					}
				}
				modifier = {
					factor = 1.5
					OR = {
						has_valid_civic = civic_memorialist
						has_valid_civic = civic_memorialist_corp
						has_valid_civic = civic_hive_memorialist
						has_valid_civic = civic_machine_memorialist
					}
				}
				set_timed_country_flag = { flag = fleet1dealproductmod3 days = @fleet1dealdecay }
			}
			
			# Volatile Motes
			1 = {
				modifier = {
					factor = 0.5
					OR = {
						has_country_flag = fleet1dealcost5 # a very good a deal
						has_country_flag = fleet1dealcost6 # a very bad deal
					}
				}
				set_timed_country_flag = { flag = fleet1dealproductmod4 days = @fleet1dealdecay }
			}
			
			# Dark Matter
			1 = {
				modifier = {
					factor = 0.1
					NOT = { has_technology = tech_mine_dark_matter }
				}
				modifier = {
					factor = 0.5
					OR = {
						has_country_flag = fleet1dealcost5 # a very good a deal
						has_country_flag = fleet1dealcost6 # a very bad deal
					}
				}
				set_timed_country_flag = { flag = fleet1dealproductmod5 days = @fleet1dealdecay }
			}
			
			# Worker Production
			1 = {
				modifier = {
					factor = 0
					is_robot_empire = yes
				}
				modifier = {
					factor = 0.1
					has_country_flag = fleet1dealcost5 # too good of a deal
				}
				modifier = {
					factor = 0.1
					OR = {
						has_country_flag = productivity_stimulant_ready
						any_owned_planet = { has_modifier = vengralian_workers }
						any_owned_planet = { has_modifier = vengralian_workers_gestalt }
					}
				}
				set_timed_country_flag = { flag = fleet1dealproductmod6 days = @fleet1dealdecay }
			}
			
			# Minor Artifacts
			1 = {
				modifier = {
					factor = 0
					has_ancrel = no
				}
				modifier = {
					factor = 0.5
					has_country_flag = fleet1dealcost2
				}
				modifier = {
					factor = 1.5
					OR = {
						has_country_flag = fleet1dealcost3
						has_country_flag = fleet1dealcost4
					}
				}
				modifier = {
					factor = 1.5
					OR = {
						has_valid_civic = civic_memorialist
						has_valid_civic = civic_memorialist_corp
						has_valid_civic = civic_hive_memorialist
						has_valid_civic = civic_machine_memorialist
					}
				}
				set_timed_country_flag = { flag = fleet1dealproductmod7 days = @fleet1dealdecay }
			}
			# Envoys
			1 = {
				modifier = {
					factor = 0
					has_modifier = fleet1_pr
				}
				modifier = {
					factor = 1.5
					OR = {
						has_valid_civic = civic_diplomatic_corps
						has_valid_civic = civic_public_relations_specialists
						has_valid_civic = civic_hive_empath
						has_valid_civic = civic_machine_emotions
					}
				}
				modifier = {
					factor = 0.25
					OR = {
						is_xenophobe = yes
						has_ai_personality = closed_hive_mind
						has_ai_personality = closed_machine_intelligence
					}
				}
				set_timed_country_flag = { flag = fleet1dealproductmod8 days = @fleet1dealdecay }
			}
		}
	}
}

cara_execute_deal1 = {
	hidden_effect = {
		# Cost
		if = {
			limit = { has_country_flag = fleet1dealcost1 }
			while = {
				count = 1
				random_owned_pop = {
					limit = {
						OR = {
							is_pop_category = specialist
							is_pop_category = complex_drone
						}
					}
					kill_pop = yes
				}
			}
			custom_tooltip = fleet1cost1_tooltip
			remove_country_flag = fleet1dealcost1
		}

		else_if = { limit = { has_country_flag = fleet1dealcost2 }
			add_resource = { alloys = -1200 }
			tooltip = { add_resource = { alloys = -1200 } }
			remove_country_flag = fleet1dealcost2
		}

		else_if = { limit = { has_country_flag = fleet1dealcost3 }
			add_resource = { unity = -500 }
			tooltip = { add_resource = { unity = -500 } }
			remove_country_flag = fleet1dealcost3
		}

		else_if = { limit = { has_country_flag = fleet1dealcost4 }
			add_modifier = {
				modifier = 6monthsocietycost
				days = 180
			}
			tooltip = {
				add_modifier = {
					modifier = 6monthsocietycost
					days = 180
				}
			}
			remove_country_flag = fleet1dealcost4
		}

		else_if = { limit = { has_country_flag = fleet1dealcost5 }
			custom_tooltip = fleet1dealcost5_tooltip
			random_owned_ship = {
				limit = { is_ship_class = shipclass_science_ship }
				# exile science officer from ship
				# and reinstate into pool
				fleet = {
					if = {
						limit = { exists = leader }
						leader = { unassign_leader = this }
					}
					delete_fleet = this
				}
			}
			remove_country_flag = fleet1dealcost5
		}

		else_if = {
			limit = { has_country_flag = fleet1dealcost6 }
			while = {
				count = 1
				random_owned_pop = {
					limit = {
						OR = {
							is_unemployed = yes
							is_pop_category = worker
							is_pop_category = simple_drone
							is_pop_category = slave
							is_pop_category = criminal
							is_pop_category = purge
						}
					}
					weights = { #Prioritize Unemployed pops
						base = 1
						modifier = {
							factor = 100
							OR = {
								is_unemployed = yes
								is_pop_category = criminal
								is_pop_category = purge
							}
						}
					}
					kill_pop = yes
				}
			}
			custom_tooltip = fleet1cost6_tooltip
			remove_country_flag = fleet1dealcost6
		}
		
		else_if = { limit = { has_country_flag = fleet1dealcostmod1 }
			add_resource = { minerals = -2000 }
			tooltip = { add_resource = { minerals = -2000 } }
			remove_country_flag = fleet1dealcostmod1
		}
		else_if = { limit = { has_country_flag = fleet1dealcostmod2 }
			add_resource = { rare_crystals = -60 }
			tooltip = { add_resource = { rare_crystals = -60 } }
			remove_country_flag = fleet1dealcostmod2
		}
		else_if = { limit = { has_country_flag = fleet1dealcostmod3 }
			random_owned_leader = {
				limit = {
					leader_class = scientist
					has_skill > 4
					NOT = { has_trait = "leader_trait_curator" }
				}
				kill_leader = {
					show_notification = no
					type = scientist
				}
			}
			custom_tooltip = fleet1costmod3_tooltip
			remove_country_flag = fleet1dealcostmod3
		}

		# Product
		if = {		limit = { has_country_flag = fleet1dealproduct1 }
			set_country_flag = bunkbeds_ready
			custom_tooltip = fleet1product1_tooltip
			remove_country_flag = fleet1dealproduct1
		}

		else_if = { limit = { has_country_flag = fleet1dealproduct2 }
			set_country_flag = tupperware_ready
			custom_tooltip = fleet1product2_tooltip
			remove_country_flag = fleet1dealproduct2
		}

		else_if = { limit = { has_country_flag = fleet1dealproduct3 }
			set_country_flag = atmospheric_deodorizer_ready
			custom_tooltip = fleet1product3_tooltip
			remove_country_flag = fleet1dealproduct3
		}

		else_if = { limit = { has_country_flag = fleet1dealproduct4 }
			add_resource = { consumer_goods = 1000 }
			tooltip = { add_resource = { consumer_goods = 1000 } }
			remove_country_flag = fleet1dealproduct4
		}

		else_if = { limit = { has_country_flag = fleet1dealproduct5 }
			add_modifier = {
				modifier = vengralian_sales_contingent
				days = 28800 # 80 years
			}
			tooltip = {
				add_modifier = {
					modifier = vengralian_sales_contingent
					days = 28800 # 80 years
				}
			}
			remove_country_flag = fleet1dealproduct5
		}
		else_if = { limit = { has_country_flag = fleet1dealproduct6 }
			add_modifier = {
				modifier = spawn_pool_stimulants
				days = 3600 # 10 years
			}
			tooltip = {
				add_modifier = {
					modifier = spawn_pool_stimulants
					days = 3600 # 10 years
				}
			}
			remove_country_flag = fleet1dealproduct6
		}

		else_if = { limit = { has_country_flag = fleet1dealproduct7 }
			add_resource = { energy = 2000 }
			tooltip = { add_resource = { energy = 2000 } }
			remove_country_flag = fleet1dealproduct7
		}
		
		else_if = { limit = { has_country_flag = fleet1dealproductmod1 }
			add_resource = { food = 3000 }
			tooltip = { add_resource = { food = 3000 } }
			remove_country_flag = fleet1dealproductmod1
		}
		
		else_if = { limit = { has_country_flag = fleet1dealproductmod2 }
			give_technology = { tech = tech_epigenetic_triggers }
			tooltip = { give_technology = { tech = tech_epigenetic_triggers } }
			remove_country_flag = fleet1dealproductmod2
		}
		
		else_if = { limit = { has_country_flag = fleet1dealproductmod3 }
			collector_surrenders_artifact = yes
			custom_tooltip = fleet1productmod3_tooltip
			remove_country_flag = fleet1dealproductmod3
			set_country_flag = fleet1_precursor
		}
		else_if = { limit = { has_country_flag = fleet1dealproductmod4 }
			add_resource = { volatile_motes = 100 }
			tooltip = { add_resource = { volatile_motes = 100 } }
			remove_country_flag = fleet1dealproductmod4
		}
		else_if = { limit = { has_country_flag = fleet1dealproductmod5 }
			add_resource = { sr_dark_matter = 25 }
			tooltip = { add_resource = { sr_dark_matter = 25 } }
			remove_country_flag = fleet1dealproductmod5
		}
		else_if = { limit = { has_country_flag = fleet1dealproductmod6 }
			set_country_flag = productivity_stimulant_ready
			custom_tooltip = fleet1productmod6_tooltip
			remove_country_flag = fleet1dealproductmod6
		}
		else_if = { limit = { has_country_flag = fleet1dealproductmod7 }
			add_resource = { minor_artifacts = 8 }
			tooltip = {
				add_resource = { minor_artifacts = 8 }
			}
			remove_country_flag = fleet1dealproductmod7
		}
		else_if = { limit = { has_country_flag = fleet1dealproductmod8 }
			add_modifier = {
				modifier = fleet1_pr
				days = 28800 # 80 years
			}
			tooltip = {
				add_modifier = {
					modifier = fleet1_pr
					days = 28800 # 80 years
				}
			}
			remove_country_flag = fleet1dealproductmod8
		}
	}
}

cara_generate_deal2 = {
	if = {
		# repeat existing price for 1 year, otherwise refresh flag
		limit = {
			NOR = {
				has_country_flag = fleet2deal1 # Numistic Shrine
				has_country_flag = fleet2deal2 # Corporate Drones
				has_country_flag = fleet2deal3 # Edict that lowers consumer goods
				has_country_flag = fleet2deal4 # Energy Technology
				has_country_flag = fleet2deal5 # Spiritual Leader
				has_country_flag = fleet2deal6 # Selling pops for crystals
				has_country_flag = fleet2deal7 # Cruiser
				has_country_flag = fleet2deal8 # Unique Planetary Deposit
				has_country_flag = fleet2deal9 # MI Upkeep Mod			
				has_country_flag = fleet2deal10 # MI Decision
				has_country_flag = fleet2deal11.a # Repeatable Cruiser
				has_country_flag = fleet2deal11.b # Repeatable Exotic Gases
				has_country_flag = fleet2deal11.c # Repeatable Energy
				has_country_flag = fleet2deal12 # Minor Artifacts
				has_country_flag = fleet2dealmod1 # Repeatable Zro
				has_country_flag = fleet2dealmod2 # Precursor Artifacts
				has_country_flag = fleet2dealmod3 # Spawn a System
				has_country_flag = fleet2dealmod4 # Admin Technology
			}
		}
		remove_country_flag = fleet2deal1
		remove_country_flag = fleet2deal2
		remove_country_flag = fleet2deal3
		remove_country_flag = fleet2deal4
		remove_country_flag = fleet2deal5
		remove_country_flag = fleet2deal6
		remove_country_flag = fleet2deal7
		remove_country_flag = fleet2deal8
		remove_country_flag = fleet2deal9
		remove_country_flag = fleet2deal10
		remove_country_flag = fleet2deal11.a
		remove_country_flag = fleet2deal11.b
		remove_country_flag = fleet2deal11.c
		remove_country_flag = fleet2deal12
		remove_country_flag = fleet2dealmod1
		remove_country_flag = fleet2dealmod2
		remove_country_flag = fleet2dealmod3
		remove_country_flag = fleet2dealmod4
		random_list = {
			100 = { # Numistic Shrine
				modifier = {
					factor = 1.5
					OR = {
						is_spiritualist = yes
						is_xenophile = yes
					}
				}
				modifier = {
					factor = 0.75
					OR = {
						is_materialist = yes
						is_xenophobe = yes
					}
				}
				modifier = {
					factor = 0
					OR = {
						has_ethic = ethic_gestalt_consciousness
						has_country_flag = nuumismatic_shrine
						any_owned_planet = {
							OR = {
								has_building = building_nuumismatic_shrine
								has_building_construction = building_nuumismatic_shrine
							}
						}
					}
				}
				set_timed_country_flag = { flag = fleet2deal1 days = @fleet2dealdecay }
			}
			100 = { # Buy Corporate Drones
				set_timed_country_flag = { flag = fleet2deal2 days = @fleet2dealdecay }
				modifier = {
					factor = 0
					has_ethic = ethic_gestalt_consciousness
					NOT = { has_civic = civic_machine_servitor }
					NOT = { has_civic = civic_machine_consciousness }
				}
				modifier = {
					factor = 1.5
					OR = {
						allows_slavery = yes
						is_xenophile = yes
					}
				}
				modifier = {
					factor = 0.75
					allows_slavery = no
					is_xenophobe = yes
				}
				modifier = {
					factor = 0.005
					has_country_flag = bought_numistic_pops
				}
				modifier = {
					factor = 0
					NOT = { exists = event_target:fleet2_recent_pop_species }	
				}
			}
			100 = { # Edict
				modifier = {
					factor = 0
					country_uses_consumer_goods = no
				}
				modifier = {
					factor = 0.5
					has_ethic = ethic_gestalt_consciousness
					NOT = { has_civic = civic_machine_servitor }
					NOT = { has_civic = civic_machine_consciousness }
				}
				modifier = {
					factor = 1.25
					has_monthly_income = { resource = consumer_goods value <= 8 }
				}
				modifier = {
					factor = 1.25
					has_monthly_income = { resource = consumer_goods value <= 1 }
				}
				modifier = {
					factor = 1.25
					has_monthly_income = { resource = energy value <= 15 }
				}
				modifier = {
					factor = 1.25
					has_monthly_income = { resource = energy value <= 1 }
				}
				modifier = {
					factor = 0
					has_country_flag = nuumismatic_visualization
				}
				set_timed_country_flag = { flag = fleet2deal3 days = @fleet2dealdecay }
			}
			100 = { # tech
				modifier = {
					factor = 0
					has_technology = tech_prescient_data_modeling
				}
				modifier = {
					factor = 1.25
					has_monthly_income = { resource = energy value <= 15 }
				}
				modifier = {
					factor = 1.25
					has_monthly_income = { resource = energy value <= 1 }
				}
				set_timed_country_flag = { flag = fleet2deal4 days = @fleet2dealdecay }
			}
			100 = {
				modifier = { # leader
					factor = 0
					OR = {
						any_owned_leader = {
							has_leader_flag = nuumismatic_priest
						}
						has_ethic = ethic_gestalt_consciousness
					}
				}
				modifier = {
					factor = 1.25
					has_monthly_income = { resource = consumer_goods value <= 8 }
				}
				modifier = {
					factor = 1.25
					has_monthly_income = { resource = consumer_goods value <= 1 }
				}
				set_timed_country_flag = { flag = fleet2deal5 days = @fleet2dealdecay }
			}
			100 = { # Selling pops for crystals
				set_timed_country_flag = { flag = fleet2deal6 days = @fleet2dealdecay }
				modifier = {
					factor = 0
					has_ethic = ethic_gestalt_consciousness
				}
				modifier = {
					factor = 0.5
					OR = {
						is_egalitarian = yes
						is_xenophobe = yes
					}
				}
				modifier = {
					factor = 0.005
					has_country_flag = sold_pops_for_crystals
				}
			}
			100 = { # Cruiser
				set_timed_country_flag = { flag = fleet2deal7 days = @fleet2dealdecay }
				modifier = {
					factor = 1.5
					OR = {
						is_militarist = yes
						is_at_war = yes
					}
				}
				modifier = {
					factor = 0.75
					is_pacifist = yes
					is_at_war = no
				}
				modifier = {
					factor = 0
					has_country_flag = bought_numistic_cruiser
				}
			}
			100 = {
				modifier = {
					factor = 0.1
					NOT = { has_ethic = ethic_gestalt_consciousness }
				}
				modifier = {
					factor = 0.01
					any_owned_planet = {
						has_deposit = d_numas_breath
					}
				}
				modifier = {
					factor = 1.5
					any_owned_planet = {
						NOT = { has_deposit = d_numas_breath }
						OR = {
							colony_type = col_generator
							num_districts = { type = district_generator value >= 4 }
						}
					}
				}
				modifier = {
					factor = 0
					NOT = {
						any_owned_planet = {
							NOT = { has_deposit = d_numas_breath }
							is_artificial = no
						}
					}
				}
				set_timed_country_flag = { flag = fleet2deal8 days = @fleet2dealdecay }
			}
			100 = {
				modifier = {
					factor = 0
					NOT = { has_authority = auth_machine_intelligence }
				}
				modifier = {
					factor = 1.25
					NOT = {
						any_owned_planet = {
							has_modifier = numistic_magnetostrips
						}
					}
				}
				modifier = {
					factor = 0.01
					any_owned_planet = {
						has_modifier = numistic_magnetostrips
					}
				}
				modifier = {
					factor = 0
					NOT = {
						any_owned_planet = {
							NOT = { has_modifier = numistic_magnetostrips }
						}
					}
				}
				set_timed_country_flag = { flag = fleet2deal9 days = @fleet2dealdecay }
			}
			100 = { # MI Decision
				modifier = {
					factor = 0
					OR = {
						NOT = { has_authority = auth_machine_intelligence }
						has_country_flag = divine_algorithm
					}
				}
				modifier = {
					factor = 1.5
					any_owned_planet = {
						NOT = { has_modifier = divine_algorithm }
						OR = {
							colony_type = col_generator
							num_districts = { type = district_generator value >= 4 }
						}
					}
				}
				set_timed_country_flag = { flag = fleet2deal10 days = @fleet2dealdecay }
			}
			1 = { # Repeatable deal when all other deals have been taken
				modifier = {
					factor = 1.5
					OR = {
						is_militarist = yes
						is_at_war = yes
					}
				}
				modifier = {
					factor = 0.75
					is_pacifist = yes
					is_at_war = no
				}
				set_timed_country_flag = { flag = fleet2deal11.a days = @fleet2dealdecay }
			}
			1 = { # Repeatable deal when all other deals have been taken
				set_timed_country_flag = { flag = fleet2deal11.b days = @fleet2dealdecay }
				modifier = {
					factor = 1.25
					has_monthly_income = { resource = exotic_gases value <= 3 }
				}
				modifier = {
					factor = 1.25
					has_monthly_income = { resource = exotic_gases value <= 1 }
				}
			}
			1 = { # Repeatable deal when all other deals have been taken
				modifier = {
					factor = 0.75
					has_monthly_income = { resource = alloys value <= 24 }
				}
				modifier = {
					factor = 0.75
					has_monthly_income = { resource = energy value >= 45 }
				}
				modifier = {
					factor = 1.25
					has_monthly_income = { resource = energy value <= 15 }
				}
				modifier = {
					factor = 1.25
					has_monthly_income = { resource = energy value <= 1 }
				}
				set_timed_country_flag = { flag = fleet2deal11.c days = @fleet2dealdecay }
			}
			100 = { # Minor Artifacts
				modifier = {
					factor = 0
					has_ancrel = no
				}
				modifier = {
					factor = 1.5
					OR = {
						has_valid_civic = civic_memorialist
						has_valid_civic = civic_memorialist_corp
						has_valid_civic = civic_hive_memorialist
						has_valid_civic = civic_machine_memorialist
					}
				}
				modifier = {
					factor = 0.01
					has_country_flag = fleet2_purchased_artifacts
				}
				set_timed_country_flag = { flag = fleet2deal12 days = @fleet2dealdecay }
			}
			100 = { # Zro
				modifier = {
					factor = 0
					is_gestalt = yes
				}
				modifier = {
					factor = 0.01
					OR = {
						NOT = { has_technology = tech_psionic_theory }
						has_country_flag = fleet2_purchased_zro
					}
				}
				modifier = {
					factor = 1.5
					is_spiritualist = yes
				}
				modifier = {
					factor = 1.25
					has_monthly_income = { resource = sr_zro value <= 2 }
				}
				modifier = {
					factor = 1.25
					has_monthly_income = { resource = sr_zro value <= 1 }
				}
				set_timed_country_flag = { flag = fleet2dealmod1 days = @fleet2dealdecay }
			}
			# Precursor Artifacts
			0 = {
				modifier = {
					add = 100
					have_active_precursor_chain = yes
					NOT = { has_country_flag = fleet2_precursor }
				}
				modifier = {
					factor = 1.5
					OR = {
						has_valid_civic = civic_memorialist
						has_valid_civic = civic_memorialist_corp
						has_valid_civic = civic_hive_memorialist
						has_valid_civic = civic_machine_memorialist
					}
				}
				set_timed_country_flag = { flag = fleet2dealmod2 days = @fleet1dealdecay }
			}
			100 = { # Spawn System
				modifier = {
					factor = 0
					has_country_flag = bought_cara_2_system
				}
				modifier = {
					factor = 0
					is_ai = yes # don't want random slow downs as new systems spawn (still needed?)
				}
				set_timed_country_flag = { flag = fleet2dealmod3 days = @fleet2dealdecay }
				# system name for desc
				random_system = {
					limit = {
						OR = {
							has_star_flag = abandoned_gateway
							has_star_flag = lgate
						}
					}
					save_event_target_as = tannhauser_gate
				}
				# in case there are no gateways
				if = {
					limit = { NOT = { exists = event_target:tannhauser_gate } }
					random_system = {
						save_event_target_as = tannhauser_gate
					}
				}
			}
			100 = { # tech
				modifier = {
					factor = 0
					has_technology = tech_numa_admin
				}
				modifier = {
					factor = 1.25
					empire_sprawl_over_cap > 0
				}
				modifier = {
					factor = 1.25
					empire_sprawl_over_cap > 10
				}
				modifier = {
					factor = 1.25
					empire_sprawl_over_cap > 20
				}
				modifier = {
					factor = 1.25
					empire_sprawl_over_cap > 40
				}
				set_timed_country_flag = { flag = fleet2dealmod4 days = @fleet2dealdecay }
			}
		}
	}
	# Get planet tar for Deal 8
	if = {
		limit = { has_country_flag = fleet2deal8 }
		random_owned_planet = {
			limit = {
				NOT = { has_deposit = d_numas_breath }
				is_artificial = no
			}
			weights = {
			base = 1
				modifier = {
					factor = 100
					OR = {
						NOT = { has_deposit = d_geothermal_vent }
						NOT = { has_deposit = d_underwater_vent }
						is_dry = yes
						is_cold = yes
						num_districts = { type = district_generator value >= 3 }
					}
				}
			}
			set_timed_planet_flag = { flag = fleet2deal8planet days = @fleet2dealdecay }
			save_event_target_as = fleet2deal8planet
		}
	}
	# Get planet tar for Deal 9
	random_owned_planet = {
		limit = {
			num_pops > 0
		}
		weights = {
			base = 1
			modifier = {
				factor = 10
				num_pops > 15
			}
			modifier = {
				factor = 10
				num_pops > 30
			}
			modifier = {
				factor = 10
				num_pops > 50
			}
		}
		set_timed_planet_flag = { flag = fleet2deal9planet days = @fleet2dealdecay }
		save_event_target_as = fleet2deal9planet
	}
}

cara_execute_deal2 = {
	hidden_effect = {
		if = { limit = { has_country_flag = fleet2deal4 }
			tooltip = {
				give_technology = { tech = tech_prescient_data_modeling }
				add_resource = { energy = -3500 }
			}
			give_technology = { tech = tech_prescient_data_modeling }
			add_resource = { energy = -3500 }
			remove_country_flag = fleet2deal4
		}

		else_if = { limit = { has_country_flag = fleet2deal3 }
			custom_tooltip = "fleet2product3_tooltip"
			tooltip = { add_resource = { energy = -2500 } }
			add_resource = { energy = -2500 }
			set_country_flag = nuumismatic_visualization
			remove_country_flag = fleet2deal3
		}

		else_if = { limit = { has_country_flag = fleet2deal1 }
			custom_tooltip = "fleet2product1_tooltip" # Shrine
			tooltip = { add_resource = { energy = -4000 } }
			add_resource = { energy = -4000 }
			set_country_flag = nuumismatic_shrine
			remove_country_flag = fleet2deal1
		}

		else_if = { limit = { has_country_flag = fleet2deal5 }
			custom_tooltip = "fleet2product5_tooltip" # Governor
			tooltip = { add_resource = { energy = -1500 } }
			add_resource = { energy = -1500 }
			create_leader = {
				class = governor
				species = event_target:caravaneer_fleet2_country.species
				name = "NAME_merchant_leader"
				skill = 3
				traits = {
					trait = leader_trait_nuumismatic_priest
				}
				event_leader = yes
				effect = {
					set_leader_flag = nuumismatic_priest
				}
			}
			remove_country_flag = fleet2deal5
		}

		else_if = { limit = { has_country_flag = fleet2deal6 }
			tooltip = { add_resource = { rare_crystals = 200 } }
			custom_tooltip = "fleet2product6_tooltip"
			while = {
				count = 1
				random_owned_pop = {
					limit = {
						species = {
							NOR = {
								is_archetype = MACHINE
								is_archetype = ROBOT
								is_archetype = PRESAPIENT
							}
						}
					}
					species = { save_global_event_target_as = fleet2_recent_pop_species }
					kill_pop = yes
				}
			}
			add_resource = { rare_crystals = 200 }
			set_country_flag = sold_pops_for_crystals
			remove_country_flag = fleet2deal6
		}

		else_if = { limit = { has_country_flag = fleet2deal2 }
			custom_tooltip = "fleet2product2_tooltip"
			tooltip = { add_resource = { energy = -3500 } }
			add_resource = { energy = -3500 }
			set_country_flag = bought_numistic_pops
			capital_scope = {
				modify_species = {
    				species = event_target:fleet2_recent_pop_species
    				add_trait = trait_nuumismatic_administration
    				ideal_planet_class = root.capital_scope
				}
				while = {
					count = 2
					create_pop = {
						species = last_created_species
					}
				}
			}remove_country_flag = fleet2deal2
		}
		else_if = { limit = { has_country_flag = fleet2deal7 }
			tooltip = { add_resource = { energy = -2500 } }
			custom_tooltip = "fleet2product7_tooltip"
			add_resource = { energy = -2500 }
			set_country_flag = bought_numistic_cruiser
			capital_scope = {
				create_fleet = {
					name = NAME_CARAVANEER_CRUISER_FLEET_NUMISTIC
					effect = {
						set_owner = root
						create_ship = {
							name = "NAME_CARAVANEER_CRUISER_NUMISTIC"
							design = NAME_Gunslinger
						}
						set_location = {
							target = root.capital_scope
							distance = 10
							angle = random
						}
					}
				}
			}
			remove_country_flag = fleet2deal7
		}
		else_if = {	limit = { has_country_flag = fleet2deal8 }
			add_resource = { minerals = -200 }
			tooltip = {
				add_resource = { minerals = -200 }
				event_target:fleet2deal8planet = { add_deposit = d_numas_breath	}
			}
			custom_tooltip = fleet2deal8.tooltip
			event_target:fleet2deal8planet = {
				add_deposit = d_numas_breath
				remove_planet_flag = fleet2deal8planet
			}
			remove_country_flag = fleet2deal8
		}
		else_if = { limit = { has_country_flag = fleet2deal9 }
			add_resource = { influence = -100 }
			tooltip = {
				add_resource = { influence = -100 }
				event_target:fleet2deal9planet = {
					add_modifier = {
						modifier = "numistic_magnetostrips"
						days = -1
					}
				}
			}
			event_target:fleet2deal9planet = {
				add_modifier = {
					modifier = "numistic_magnetostrips"
					days = -1
				}
				remove_planet_flag = fleet2deal9planet
			}
			remove_country_flag = fleet2deal9
		}
		else_if = { limit = { has_country_flag = fleet2deal10 }
			add_resource = { minerals = -2000 }
			tooltip = {
				add_resource = { minerals = -2000 }
			}
			custom_tooltip = fleetproduct10_tooltip
			set_country_flag = divine_algorithm
			remove_country_flag = fleet2deal10
		}
		else_if = { limit = { has_country_flag = fleet2deal11.a }
			tooltip = { add_resource = { energy = -2500 } }
			custom_tooltip = "fleet2product7_tooltip"
			add_resource = { energy = -2500 }
			set_country_flag = bought_numistic_cruiser
			capital_scope = {
				create_fleet = {
					name = NAME_CARAVANEER_CRUISER_FLEET_NUMISTIC
					effect = {
						set_owner = root
						create_ship = {
							name = "NAME_CARAVANEER_CRUISER_NUMISTIC"
							design = NAME_Gunslinger
						}
						set_location = {
							target = root.capital_scope
							distance = 10
							angle = random
						}
					}
				}
			}
			remove_country_flag = fleet2deal11.a
		}
		else_if = { limit = { has_country_flag = fleet2deal11.b }
			add_resource = { energy = -1700 }
			add_resource = { exotic_gases = 200 }
			tooltip = {
				add_resource = { energy = -1700 }
				add_resource = { exotic_gases = 200 }
			}
			remove_country_flag = fleet2deal11.b
		}
		else_if = { limit = { has_country_flag = fleet2deal11.c }
			add_resource = { alloys = -500 }
			add_resource = { energy = 3000 }
			tooltip = {
				add_resource = { alloys = -500 }
				add_resource = { energy = 3000 }
			}
			remove_country_flag = fleet2deal11.c
		}
		else_if = { limit = { has_country_flag = fleet2deal12 }
			add_resource = { alloys = -300 }
			add_resource = { minor_artifacts = 5 }
			tooltip = {
				add_resource = { alloys = -300 }
				add_resource = { minor_artifacts = 5 }
			}
			remove_country_flag = fleet2deal12
			if = {
				limit = {
					NOT = { has_country_flag = fleet2_purchased_artifacts }
				}
				set_country_flag = fleet2_purchased_artifacts
			}
		}
		else_if = { limit = { has_country_flag = fleet2dealmod1 }
			add_resource = { consumer_goods = -1000 }
			add_resource = { sr_zro = 75 }
			tooltip = {
				add_resource = { consumer_goods = -1000 }
				add_resource = { sr_zro = 75 }
			}
			if = {
				limit = {
					NOT = { has_country_flag = fleet2_purchased_zro }
				}
				set_country_flag = fleet2_purchased_zro
			}
			remove_country_flag = fleet2dealmod1
		}
		else_if = { limit = { has_country_flag = fleet2dealmod2 }
			add_resource = { influence = -100 }
			collector_surrenders_artifact = yes
			tooltip = {
				add_resource = { influence = -100 }
			}
			custom_tooltip = fleet1productmod3_tooltip
			set_country_flag = fleet2_precursor
			remove_country_flag = fleet2dealmod2
		}
		else_if = { limit = { has_country_flag = fleet2dealmod3 }
			random_system_within_border = {
				random_list = {
					# Gaia World
					100 = {
						spawn_system = {
							min_distance = 10
							max_distance = 25
							initializer = "cara2_01"
						}
					}
					# Rare Resources
					100 = {
						spawn_system = {
							min_distance = 10
							max_distance = 25
							initializer = "cara2_02"
						}
					}
					# Dark Matter + L-Gate
					100 = {
						modifier = {
							factor = 0
							has_distar = no
						}
						spawn_system = {
							min_distance = 10
							max_distance = 25
							initializer = "cara2_03"
						}
					}
					# Three abandoned habitats
					10 = {
						spawn_system = {
							min_distance = 10
							max_distance = 25
							initializer = "cara2_04"
						}
					}
					# Vanilla Unique Systems (only if not spawned)
					10 = {
						modifier = {
							factor = 0
							any_system = { has_star_flag = guardians_of_zanaam }
						}
						spawn_system = {
							min_distance = 10
							max_distance = 25
							initializer = "special_init_06"
						}
						closest_system = {
							limit = {
								has_star_flag = guardians_of_zanaam
								NOT = {
									any_system_planet = {
										is_surveyed = { who = ROOT status = yes } 
									}
								}
							}
							set_star_flag = cara2_system
						}
					}
					10 = {
						modifier = {
							factor = 0
							any_system = { has_star_flag = sanctuary_system }
						}
						spawn_system = {
							min_distance = 10
							max_distance = 25
							initializer = "sanctuary_system"
						}
						closest_system = {
							limit = {
								has_star_flag = sanctuary_system
								NOT = {
									any_system_planet = {
										is_surveyed = { who = ROOT status = yes } 
									}
								}
							}
							set_star_flag = cara2_system
						}
					}
					10 = {
						modifier = {
							factor = 0
							any_system = { has_star_flag = manufactory_system }
						}
						spawn_system = {
							min_distance = 10
							max_distance = 25
							initializer = "crystal_manufactory_system"
						}
						closest_system = {
							limit = {
								has_star_flag = manufactory_system
								NOT = {
									any_system_planet = {
										is_surveyed = { who = ROOT status = yes } 
									}
								}
							}
							set_star_flag = cara2_system
						}
					}
					10 = {
						modifier = {
							factor = 0
							OR = {
								has_distar = no
								any_system = { has_star_flag = big_rip_system }
							}
						}
						spawn_system = {
							min_distance = 10
							max_distance = 25
							initializer = "big_rip_system"
						}
						closest_system = {
							limit = {
								has_star_flag = big_rip_system
								NOT = {
									any_system_planet = {
										is_surveyed = { who = ROOT status = yes } 
									}
								}
							}
							set_star_flag = cara2_system
						}
					}
					5 = {
						modifier = {
							factor = 0
							OR = {
								has_distar = no
								any_system = { has_star_flag = time_loop_world_system }
							}
						}
						spawn_system = {
							min_distance = 10
							max_distance = 25
							initializer = "time_loop_world_system"
						}
						closest_system = {
							limit = {
								has_star_flag = time_loop_world_system
								NOT = {
									any_system_planet = {
										is_surveyed = { who = ROOT status = yes } 
									}
								}
							}
							set_star_flag = cara2_system
						}
					}
					10 = {
						modifier = {
							factor = 0
							OR = {
								has_distar = no
								any_system = { has_star_flag = primitive_robot_system }
							}
						}
						spawn_system = {
							min_distance = 10
							max_distance = 25
							initializer = "primitive_robot_system"
						}
						closest_system = {
							limit = {
								has_star_flag = primitive_robot_system
								NOT = {
									any_system_planet = {
										is_surveyed = { who = ROOT status = yes } 
									}
								}
							}
							set_star_flag = cara2_system
						}
					}
					10 = {
						modifier = {
							factor = 0
							OR = {
								has_distar = no
								any_system = { has_star_flag = collapse_system }
							}
						}
						spawn_system = {
							min_distance = 10
							max_distance = 25
							initializer = "collapse_system"
						}
						closest_system = {
							limit = {
								has_star_flag = collapse_system
								NOT = {
									any_system_planet = {
										is_surveyed = { who = ROOT status = yes } 
									}
								}
							}
							set_star_flag = cara2_system
						}
					}
					10 = {
						modifier = {
							factor = 0
							OR = {
								has_distar = no
								any_system = { has_star_flag = old_foes_system }
							}
						}
						spawn_system = {
							min_distance = 10
							max_distance = 25
							initializer = "old_foes_system"
						}
						closest_system = {
							limit = {
								has_star_flag = old_foes_system
								NOT = {
									any_system_planet = {
										is_surveyed = { who = ROOT status = yes } 
									}
								}
							}
							set_star_flag = cara2_system
						}
					}
					10 = {
						modifier = {
							factor = 0
							OR = {
								has_distar = no
								any_system = { has_star_flag = living_planet_system }
							}
						}
						spawn_system = {
							min_distance = 10
							max_distance = 25
							initializer = "living_planet_system"
						}
						closest_system = {
							limit = {
								has_star_flag = living_planet_system
								NOT = {
									any_system_planet = {
										is_surveyed = { who = ROOT status = yes } 
									}
								}
							}
							set_star_flag = cara2_system
						}
					}
					10 = {
						modifier = {
							factor = 0
							OR = {
								has_distar = no
								any_system = { has_star_flag = phaseshift_system }
							}
						}
						spawn_system = {
							min_distance = 10
							max_distance = 25
							initializer = "distar_phaseshift_system"
						}
						closest_system = {
							limit = {
								has_star_flag = phaseshift_system
								NOT = {
									any_system_planet = {
										is_surveyed = { who = ROOT status = yes } 
									}
								}
							}
							set_star_flag = cara2_system
						}
					}
					10 = {
						modifier = {
							factor = 0
							OR = {
								has_ancrel = no
								any_system = { has_star_flag = relic_system_1 }
							}
						}
						spawn_system = {
							min_distance = 10
							max_distance = 25
							initializer = "relic_system_1"
						}
						closest_system = {
							limit = {
								has_star_flag = relic_system_1
								NOT = {
									any_system_planet = {
										is_surveyed = { who = ROOT status = yes } 
									}
								}
							}
							set_star_flag = cara2_system
						}
					}
					10 = {
						modifier = {
							factor = 0
							OR = {
								has_ancrel = no
								any_system = { has_star_flag = relic_system_4 }
							}
						}
						spawn_system = {
							min_distance = 10
							max_distance = 25
							initializer = "relic_system_4"
						}
						closest_system = {
							limit = {
								has_star_flag = relic_system_4
								NOT = {
									any_system_planet = {
										is_surveyed = { who = ROOT status = yes } 
									}
								}
							}
							set_star_flag = cara2_system
						}
					}
					# Megastructures
					10 = {
						spawn_system = {
							min_distance = 10
							max_distance = 25
							initializer = "megacorp_matter_decompressor_init_01"
						}
						closest_system = {
							limit = {
								has_star_flag = ruined_matter_decompressor_system
								NOT = {
									any_system_planet = {
										is_surveyed = { who = ROOT status = yes } 
									}
								}
							}
							set_star_flag = cara2_system
						}
					}
					10 = {
						spawn_system = {
							min_distance = 10
							max_distance = 25
							initializer = "megacorp_strategic_coordination_center_init_01"
						}
						closest_system = {
							limit = {
								has_star_flag = ruined_strategic_coordination_center_system
								NOT = {
									any_system_planet = {
										is_surveyed = { who = ROOT status = yes } 
									}
								}
							}
							set_star_flag = cara2_system
						}
					}
					10 = {
						spawn_system = {
							min_distance = 10
							max_distance = 25
							initializer = "megacorp_mega_art_installation_init_01"
						}
						closest_system = {
							limit = {
								has_star_flag = ruined_mega_art_installation_system
								NOT = {
									any_system_planet = {
										is_surveyed = { who = ROOT status = yes } 
									}
								}
							}
							set_star_flag = cara2_system
						}
					}
					10 = {
						spawn_system = {
							min_distance = 10
							max_distance = 25
							initializer = "megacorp_interstellar_assembly_init_01"
						}
						closest_system = {
							limit = {
								has_star_flag = ruined_interstellar_assembly_system
								NOT = {
									any_system_planet = {
										is_surveyed = { who = ROOT status = yes } 
									}
								}
							}
							set_star_flag = cara2_system
						}
					}
					10 = {
						modifier = {
							factor = 0
							NOT = { host_has_dlc = "Utopia" }
						}
						spawn_system = {
							min_distance = 10
							max_distance = 25
							initializer = "dyson_sphere_init_01"
						}
						closest_system = {
							limit = {
								has_star_flag = ruined_dyson_system
								NOT = {
									any_system_planet = {
										is_surveyed = { who = ROOT status = yes } 
									}
								}
							}
							set_star_flag = cara2_system
						}
					}
					10 = {
						modifier = {
							factor = 0
							NOT = { host_has_dlc = "Utopia" }
						}
						spawn_system = {
							min_distance = 10
							max_distance = 25
							initializer = "science_nexus_init_01"
						}
						closest_system = {
							limit = {
								has_star_flag = ruined_nexus_system
								NOT = {
									any_system_planet = {
										is_surveyed = { who = ROOT status = yes } 
									}
								}
							}
							set_star_flag = cara2_system
						}
					}
					10 = {
						modifier = {
							factor = 0
							NOT = { host_has_dlc = "Utopia" }
						}
						spawn_system = {
							min_distance = 10
							max_distance = 25
							initializer = "sentry_array_init_01"
						}
						closest_system = {
							limit = {
								has_star_flag = ruined_sentry_system
								NOT = {
									any_system_planet = {
										is_surveyed = { who = ROOT status = yes } 
									}
								}
							}
							set_star_flag = cara2_system
						}
					}
					10 = {
						modifier = {
							factor = 0
							NOT = { host_has_dlc = "Utopia" }
						}
						spawn_system = {
							min_distance = 10
							max_distance = 25
							initializer = "ring_world_init_01"
						}
						closest_system = {
							limit = {
								has_star_flag = ruined_ring_system
								NOT = {
									any_system_planet = {
										is_surveyed = { who = ROOT status = yes } 
									}
								}
							}
							set_star_flag = cara2_system
						}
					}
					# Leviathans
					5 = {
						modifier = {
							factor = 0
							has_leviathans = no
						}
						spawn_system = {
							min_distance = 10
							max_distance = 25
							initializer = "guardians_init_hive"
						}
						closest_system = {
							limit = {
								has_star_flag = guardians_hive_system
								NOT = {
									any_system_planet = {
										is_surveyed = { who = ROOT status = yes } 
									}
								}
							}
							set_star_flag = cara2_system
						}
					}
					5 = {
						modifier = {
							factor = 0
							OR = {
								has_leviathans = no
								NOT = { mid_game_years_passed >= 0 } # so it doesn't compete with normally-spawned wraith systems
							}
						}
						spawn_system = {
							min_distance = 10
							max_distance = 25
							initializer = "guardians_init_wraith"
						}
						closest_system = {
							limit = {
								has_star_flag = guardians_wraith_system
								NOT = {
									any_system_planet = {
										is_surveyed = { who = ROOT status = yes } 
									}
								}
							}
							set_star_flag = cara2_system
						}
					}
				}
			}
			random_system = {
				limit = {
					has_star_flag = cara2_system
				}
				save_event_target_as = cara_system
			}
			create_point_of_interest = {
				id = cara_system_poi.1
				name = "cara_system_1_poi"
				desc = "cara_system_1_poi_desc"
				event_chain = cara_system_chain
				location = event_target:cara_system
			}
			add_modifier = { modifier = 12monthengineeringcost days = 360 }
			set_country_flag = bought_cara_2_system
			tooltip = {
				add_modifier = { modifier = 12monthengineeringcost days = 360 }
			}
			custom_tooltip = fleet2dealmod3.product.tooltip
			remove_country_flag = fleet2dealmod3
		}
		if = { limit = { has_country_flag = fleet2dealmod4 }
			tooltip = {
				give_technology = { tech = tech_numa_admin }
				add_resource = { volatile_motes = -200 }
			}
			give_technology = { tech = tech_numa_admin }
			add_resource = { volatile_motes = -200 }
			remove_country_flag = fleet2dealmod4
		}
	}
}

cara_generate_deal3 = {
	if = {
		# repeat existing deal for 1 year, otherwise refresh flag
		limit = {
			NOR = {
				has_country_flag = fleet3deal1 #Selling minerals
				has_country_flag = fleet3deal2 #Selling Racket leader
				has_country_flag = fleet3deal3 #Selling pops
				has_country_flag = fleet3deal4 #Selling alloy/gas/living metal
				has_country_flag = fleet3deal5 #Selling unique building
				has_country_flag = fleet3deal6 #Selling unique ship weapons tech
				has_country_flag = fleet3deal7 #Selling energy mining platform "upgrade" (planetary energy deposit)
				has_country_flag = fleet3deal8 #Selling tech drone planet mod
				has_country_flag = fleet3deal9 #Selling Caravan destroyer
				has_country_flag = fleet3dealmod1 #Selling munitions
				has_country_flag = fleet3dealmod2 #Selling minerals (machine)
				has_country_flag = fleet3dealmod3 #Precursor Artifacts
				has_country_flag = fleet3dealmod4 #Mineral Sniffer
				has_country_flag = fleet3dealmod5 #Minor Artifacts
				has_country_flag = fleet3dealmod6 #Scavengers
				has_country_flag = fleet3dealmod7 #Intel
			}
		}
		remove_country_flag = fleet3deal1
		remove_country_flag = fleet3deal2
		remove_country_flag = fleet3deal3
		remove_country_flag = fleet3deal4
		remove_country_flag = fleet3deal5
		remove_country_flag = fleet3deal6
		remove_country_flag = fleet3deal7
		remove_country_flag = fleet3deal8
		remove_country_flag = fleet3deal9
		remove_country_flag = fleet3dealmod1
		remove_country_flag = fleet3dealmod2
		remove_country_flag = fleet3dealmod3
		remove_country_flag = fleet3dealmod4
		remove_country_flag = fleet3dealmod5
		remove_country_flag = fleet3dealmod6
		remove_country_flag = fleet3dealmod7
		random_list = {
			
			# minerals
			1 = {
				modifier = {
					factor = 0.5
					has_monthly_income = { resource = minerals value >= 100 }
				}
				modifier = {
					factor = 0
					country_uses_food = no
				}
				set_timed_country_flag = { flag = fleet3deal1 days = @fleet3dealdecay }
			}
			
			#Selling Racket leader
			1 = {
				modifier = {
					factor = 0
					has_authority = auth_hive_mind
				}
				modifier = {
					factor = 1.25
					is_xenophile = yes
				}
				modifier = {
					factor = 0.75
					is_xenophobe = yes
				}
				set_timed_country_flag = { flag = fleet3deal2 days = @fleet3dealdecay }
			}
			
			#Selling pops
			1 = {
				modifier = {
					factor = 0
					has_authority = auth_hive_mind
				}
				modifier = {
					factor = 1.25
					is_xenophile = yes
				}
				modifier = {
					factor = 0.75
					is_xenophobe = yes
				}
				modifier = {
					factor = 0.5
					NOT = {
						any_owned_planet = {
							free_housing > 3
						}
					}
				}
				set_timed_country_flag = { flag = fleet3deal3 days = @fleet3dealdecay }
			}
			
			#Selling alloy/gas/living metal
			1 = {
				set_timed_country_flag = { flag = fleet3deal4 days = @fleet3dealdecay }
				modifier = {
					factor = 0
					NOR = {
						resource_stockpile_compare = {
							resource = sr_dark_matter
							value > 15
						}
						resource_stockpile_compare = {
							resource = rare_crystals
							value > 55
						}
						resource_stockpile_compare = {
							resource = sr_zro
							value > 15
						}
					}
				}
			}
			
			#Selling unique building
			0 = {
				modifier = {
					add = 3
					has_ethic = ethic_gestalt_consciousness
				}
				modifier = {
					factor = 0
					OR = {
						any_owned_planet = {
							has_building = building_waste_reprocessing_center
						}
						has_country_flag = bought_waste_reprocessing_center
					}
				}
				modifier = {
					factor = 1.5
					any_owned_planet = {
						NOT = { has_building = building_waste_reprocessing_center }
						OR = {
							colony_type = col_generator
							num_districts = { type = district_generator value >= 4 }
						}
					}
				}
				set_timed_country_flag = { flag = fleet3deal5 days = @fleet3dealdecay }
			}
			
			#Selling unique ship weapons tech
			1 = {
				modifier = {
					factor = 0
					has_technology = tech_orbital_trash_dispersal
				}
				modifier = {
					factor = 1.5
					is_militarist = yes
				}
				modifier = {
					factor = 0.75
					is_pacifist = yes
				}
				set_timed_country_flag = { flag = fleet3deal6 days = @fleet3dealdecay }
			}
			
			# Energy Extractor
			1 = {
				modifier = {
					add = 2
					has_ethic = ethic_gestalt_consciousness
				}
				modifier = { #Low chance if you've already gotten this deal once and still have that planet
					factor = 0.1
					has_country_flag = got_fleet3deal7
					any_planet_within_border = {
						has_modifier = "racket_energy_extractor"
					}
				}
				modifier = {
					factor = 0
					NOT = {
						any_planet_within_border = {
							has_mining_station = yes
							has_resource = { type = energy amount > 0 }
							NOT = { has_modifier = racket_energy_extractor }
						}
					}
				}
				set_timed_country_flag = { flag = fleet3deal7 days = @fleet3dealdecay }
			}
			
			#Selling tech drone planet mod
			2 = {
				modifier = {
					factor = 0
					NOR = {
						has_authority = auth_machine_intelligence
						is_synthetic_empire = yes
					}
				}
				modifier = { #Lower chance if you've already gotten this deal once and still have that planet
					factor = 0.1
					has_country_flag = got_fleet3deal8
					any_owned_planet = {
						has_modifier = racket_generator_regulator
					}
				}
				modifier = { #Do not offer if every owned habitable planet already has the mod
					factor = 0
					NOT = {
						any_owned_planet = {
							OR = {
								is_colony = yes
								is_capital = yes
								is_colonizable = yes
							}
							NOT = { has_modifier = racket_generator_regulator }
						}
					}
				}
				modifier = {
					factor = 1.5
					any_owned_planet = {
						NOT = { has_modifier = racket_generator_regulator }
						OR = {
							colony_type = col_generator
							num_districts = { type = district_generator value >= 4 }
						}
					}
				}
				set_timed_country_flag = { flag = fleet3deal8 days = @fleet3dealdecay }
			}
			
			#Selling Caravan destroyer
			1 = {
				modifier = {
					factor = 2
					years_passed < 50
				}
				modifier = {
					factor = 1.5
					OR = {
						is_militarist = yes
						is_at_war = yes
					}
				}
				modifier = {
					factor = 0.75
					is_pacifist = yes
					is_at_war = no
				}
				modifier = {
					factor = 0
					any_owned_ship = {
						is_ship_size = caravaneer_destroyer_01
					}
				}
				set_timed_country_flag = { flag = fleet3deal9 days = @fleet3dealdecay }
			}
			
			# Munitions
			1 = {
				modifier = {
					factor = 1.5
					is_militarist = yes
				}
				modifier = {
					factor = 0.5
					is_pacifist = yes
				}
				modifier = {
					factor = 0
					has_modifier = fleet3_munitions
				}
				set_timed_country_flag = { flag = fleet3dealmod1 days = @fleet3dealdecay }
			}
			
			# Minerals (Machine)
			1 = {
				modifier = {
					factor = 0.5
					has_monthly_income = { resource = minerals value >= 100 }
				}
				modifier = {
					factor = 0
					country_uses_food = yes
				}
				modifier = {
					factor = 0
					OR = {
						has_civic = civic_machine_servitor
						has_civic = civic_machine_assimilator
						has_civic = civic_machine_consciousness
					}
				}
				set_timed_country_flag = { flag = fleet3dealmod2 days = @fleet3dealdecay }
			}
			
			#Precursor Artifacts
			0 = {
				modifier = {
					add = 1
					have_active_precursor_chain = yes
					NOT = { has_country_flag = fleet3_precursor }
				}
				modifier = {
					factor = 1.5
					OR = {
						has_valid_civic = civic_memorialist
						has_valid_civic = civic_memorialist_corp
						has_valid_civic = civic_hive_memorialist
						has_valid_civic = civic_machine_memorialist
					}
				}
				set_timed_country_flag = { flag = fleet3dealmod3 days = @fleet1dealdecay }
			}
			
			# Mineral Sniffer
			1 = {
				modifier = {
					add = 2
					has_ethic = ethic_gestalt_consciousness
				}
				modifier = { #Low chance if you've already gotten this deal once and still have that planet
					factor = 0.1
					has_country_flag = got_fleet3dealmod4
					any_planet_within_border = {
						has_modifier = "racket_mineral_sniffer"
					}
				}
				modifier = {
					factor = 1.5
					NOT = {
						any_planet_within_border = {
							has_modifier = racket_mineral_sniffer
						}
					}
				}
				modifier = {
					factor = 0
					NOT = {
						any_planet_within_border = {
							has_mining_station = yes
							has_resource = { type = minerals amount > 0 }
							NOT = { has_modifier = racket_mineral_sniffer }
							NOT = { is_planet_class = pc_molten }
						}
					}
				}
				set_timed_country_flag = { flag = fleet3dealmod4 days = @fleet3dealdecay }
			}
			
			# Minor Artifacts
			1 = {
				modifier = {
					factor = 0
					has_ancrel = no
				}
				modifier = {
					factor = 1.5
					OR = {
						has_valid_civic = civic_memorialist
						has_valid_civic = civic_memorialist_corp
						has_valid_civic = civic_hive_memorialist
						has_valid_civic = civic_machine_memorialist
					}
				}
				set_timed_country_flag = { flag = fleet3dealmod5 days = @fleet3dealdecay }
			}
			
			#Scavengers
			1 = {
				modifier = {
					factor = 1.5
					has_monthly_income = { resource = minerals value <= 50 }
				}
				modifier = {
					factor = 0
					has_modifier = fleet3_scavengers
				}
				set_timed_country_flag = { flag = fleet3dealmod6 days = @fleet3dealdecay }
			}
			#Intel
			1 = {
				modifier = {
					factor = 1.5
					OR = {
						has_civic = civic_cutthroat_politics
						has_civic = civic_police_state
						has_civic = civic_brand_loyalty
						has_civic = civic_hive_pooled_knowledge
						has_civic = civic_machine_introspective
						has_civic = civic_machine_predictive_analysis
						has_civic = civic_shadow_council_megacorp
						has_civic = civic_self_experimentation
					}
				}
				modifier = {
					factor = 0.5
					OR = {
						has_civic = civic_inwards_perfection
						has_civic = civic_closed_collective
						has_civic = civic_closed_network
					}
				}
				modifier = {
					factor = 0
					NOT = {
						any_relation = {
							OR = { is_country_type = default is_country_type = ascended_empire is_country_type = lost_empire }
							has_communications = ROOT
							ROOT = { intel = { who = PREV value < 100 } }
						}
					}
				}
				set_timed_country_flag = { flag = fleet3dealmod7 days = @fleet3dealdecay }
			}
		}
	}
	#Get costs and products for Deal 1
	if = {
		limit = {
			has_country_flag = fleet3deal1
			NOR = {
				has_country_flag = fleet3deal1cost1
				has_country_flag = fleet3deal1cost2
				has_country_flag = fleet3deal1cost3
				has_country_flag = fleet3deal1product1
				has_country_flag = fleet3deal1product2
				has_country_flag = fleet3deal1product3
			}
		}
		if = {
			limit = { years_passed < 50 }
			set_timed_country_flag = { flag = fleet3deal1cost1 days = @fleet3dealdecay }
			set_timed_country_flag = { flag = fleet3deal1product1 days = @fleet3dealdecay }
		}
		else_if = {
			limit = { years_passed > 49 years_passed < 150 }
			set_timed_country_flag = { flag = fleet3deal1cost2 days = @fleet3dealdecay }
			set_timed_country_flag = { flag = fleet3deal1product2 days = @fleet3dealdecay }
		}
		else_if = {
			limit = { years_passed > 149 }
			set_timed_country_flag = { flag = fleet3deal1cost3 days = @fleet3dealdecay }
			set_timed_country_flag = { flag = fleet3deal1product3 days = @fleet3dealdecay }
		}
	}
	#Get costs and products for Deal 2
	if = { #Costs
		limit = {
			OR = {
				has_country_flag = fleet3deal2
				has_country_flag = fleet3dealmod1
			}
			NOR = {
				has_country_flag = fleet3deal2cost1
				has_country_flag = fleet3deal2cost2
				has_country_flag = fleet3deal2cost3
				has_country_flag = fleet3deal2product1
				has_country_flag = fleet3deal2product2
			}
		}
		random_list = {
			1 = { set_timed_country_flag = { flag = fleet3deal2cost1 days = @fleet3dealdecay } }
			1 = { set_timed_country_flag = { flag = fleet3deal2cost2 days = @fleet3dealdecay } }
			1 = {
				modifier = {
					factor = 0
					country_uses_consumer_goods = no
				}
				set_timed_country_flag = { flag = fleet3deal2cost3 days = @fleet3dealdecay }
			}
		}
	}
	if = { #Products
		limit = { has_country_flag = fleet3deal2 }
		random_list = {
			1 = { set_timed_country_flag = { flag = fleet3deal2product1 days = @fleet3dealdecay } }
			1 = {
				modifier = {
					factor = 1.5
					has_ethic = ethic_gestalt_consciousness
				}
				set_timed_country_flag = { flag = fleet3deal2product2 days = @fleet3dealdecay }
			}
		}
	}
	#Get tar planet for Deal 3
	if = {
		limit = { has_country_flag = fleet3deal3 }
		if = {
			limit = {
				any_owned_planet = {
					free_housing > 3
				}
			}
			random_owned_planet = {
				limit = {
					free_housing > 3
				}
				set_timed_planet_flag = { flag = fleet3deal3planet days = @fleet3dealdecay }
				save_event_target_as = fleet3deal3planet
			}
		}
		else_if = {
			limit = {
				any_owned_planet = {
					free_housing > 2
				}
			}
			random_owned_planet = {
				limit = {
					free_housing > 2
				}
				set_timed_planet_flag = { flag = fleet3deal3planet days = @fleet3dealdecay }
				save_event_target_as = fleet3deal3planet
			}
		}
		else_if = {
			limit = {
				any_owned_planet = {
					free_housing > 1
				}
			}
			random_owned_planet = {
				limit = {
					free_housing > 1
				}
				set_timed_planet_flag = { flag = fleet3deal3planet days = @fleet3dealdecay }
				save_event_target_as = fleet3deal3planet
			}
		}
		else = {
			capital_scope = {
				set_timed_planet_flag = { flag = fleet3deal3planet days = @fleet3dealdecay }
				save_event_target_as = fleet3deal3planet
			}
		}
	}
	#Get costs and products for Deal 4
	if = { #Costs
		limit = {
			has_country_flag = fleet3deal4
			NOR = {
				has_country_flag = fleet3deal4cost1
				has_country_flag = fleet3deal4cost2
				has_country_flag = fleet3deal4cost3
			}
		}
		random_list = {
			1 = {
				set_timed_country_flag = { flag = fleet3deal4cost1 days = @fleet3dealdecay }
				modifier = {
					factor = 0
					NOT = {
						resource_stockpile_compare = {
							resource = sr_dark_matter
							value > 15
						}
					}
				}
			}
			1 = {
				set_timed_country_flag = { flag = fleet3deal4cost2 days = @fleet3dealdecay }
				modifier = {
					factor = 0
					NOT = {
						resource_stockpile_compare = {
							resource = rare_crystals
							value > 55
						}
					}
				}
			}
			1 = {
				set_timed_country_flag = { flag = fleet3deal4cost3 days = @fleet3dealdecay }
				modifier = {
					factor = 0
					NOT = {
						resource_stockpile_compare = {
							resource = sr_zro
							value > 15
						}
					}
				}
			}
		}
	}
	if = { #Products
		limit = {
			has_country_flag = fleet3deal4
			NOR = {
				has_country_flag = fleet3deal4product1
				has_country_flag = fleet3deal4product2
				has_country_flag = fleet3deal4product3
				has_country_flag = fleet3deal4productmod1
			}
		}
		random_list = {
			1 = { set_timed_country_flag = { flag = fleet3deal4product1 days = @fleet3dealdecay } }
			1 = { set_timed_country_flag = { flag = fleet3deal4product2 days = @fleet3dealdecay } }
			1 = { set_timed_country_flag = { flag = fleet3deal4product3 days = @fleet3dealdecay } }
			1 = {
				modifier = {
					factor = 0
					has_distar = no
				}
				set_timed_country_flag = { flag = fleet3deal4productmod1 days = @fleet3dealdecay }
			}
		}
	}
	#Get costs for Deal 6
	if = { #Costs
		limit = { 
			OR = {
				has_country_flag = fleet3deal6
				has_country_flag = fleet3dealmod3
				has_country_flag = fleet3dealmod5
			}
			NOR = {
				has_country_flag = fleet3deal6cost1
				has_country_flag = fleet3deal6cost2
				has_country_flag = fleet3deal6cost3
			}
		}
		random_list = {
			1 = { set_timed_country_flag = { flag = fleet3deal6cost1 days = @fleet3dealdecay } }
			1 = { set_timed_country_flag = { flag = fleet3deal6cost2 days = @fleet3dealdecay } }
			1 = { #Non-Servs will not have Consumer Goods
				modifier = {
					factor = 0
					country_uses_consumer_goods = no
				}
				set_timed_country_flag = { flag = fleet3deal6cost3 days = @fleet3dealdecay }
			}
		}
	}
	#Get costs for Deal 7
	if = { #Costs
		limit = {
			has_country_flag = fleet3deal7
			NOR = {
				has_country_flag = fleet3deal7cost1
				has_country_flag = fleet3deal7cost2
				has_country_flag = fleet3deal7cost3
			}
		}
		random_list = {
			2 = { set_timed_country_flag = { flag = fleet3deal7cost1 days = @fleet3dealdecay } }
			1 = {
				set_timed_country_flag = { flag = fleet3deal7cost2 days = @fleet3dealdecay }
				modifier = {
					factor = 0
					NOT = {
						resource_stockpile_compare = {
							resource = exotic_gases
							value > 1
						}
					}
				}
			}
			2 = { #Non-Servs will not have Consumer Goods
				modifier = {
					factor = 0
					country_uses_consumer_goods = no
				}
				set_timed_country_flag = { flag = fleet3deal7cost3 days = @fleet3dealdecay }
			}
		}
		#Get station tar for Deal 7
		random_planet_within_border = {
			limit = {
				has_mining_station = yes
				has_resource = { type = energy amount > 0 }
				NOT = { has_modifier = racket_energy_extractor }
			}
			set_timed_planet_flag = { flag = fleet3deal7planetflag days = @fleet3dealdecay }
			save_event_target_as = fleet3deal7planet
		}
	}
	#Get costs for Deal 8
	if = {
		limit = {
			has_country_flag = fleet3deal8
			NOR = {
				has_country_flag = fleet3deal8cost1
				has_country_flag = fleet3deal8cost2
			}
		}
		random_list = {
			1 = {
				modifier = {
					factor = 0
					NOR = { #Since non-Servs can't produce Consumer Goods, an edge-case catch
						country_uses_consumer_goods = yes
						resource_stockpile_compare = {
							resource = consumer_goods
							value >= 300
						}
					}
				}
				set_timed_country_flag = { flag = fleet3deal8cost1 days = @fleet3dealdecay }
			}
			1 = { set_timed_country_flag = { flag = fleet3deal8cost2 days = @fleet3dealdecay } }
		}
	}
	#Get planet tar for Deal 8
	if = {
		limit = { has_country_flag = fleet3deal8 }
		random_owned_planet = {
			limit = {
				has_district = district_generator
			}
			weights = {
				base = 1
				modifier = { #Prio planets w many techies
					factor = 100
					count_owned_pop = {
						count > 5
						limit = {
							has_job = technician_drone
						}
					}
				}
			}
			set_timed_planet_flag = { flag = fleet3deal8planet days = @fleet3dealdecay }
			save_event_target_as = fleet3deal8planet
		}
	}
	#Get costs and products for Deal Mod 2
	if = {
		limit = {
			has_country_flag = fleet3dealmod2
			NOR = {
				has_country_flag = fleet3dealmod2cost1
				has_country_flag = fleet3dealmod2cost2
				has_country_flag = fleet3dealmod2cost3
				has_country_flag = fleet3deal1product1
				has_country_flag = fleet3deal1product2
				has_country_flag = fleet3deal1product3
			}
		}
		if = {
			limit = { years_passed < 50 }
			set_timed_country_flag = { flag = fleet3dealmod2cost1 days = @fleet3dealdecay }
			set_timed_country_flag = { flag = fleet3deal1product1 days = @fleet3dealdecay }
		}
		else_if = {
			limit = { years_passed > 49 years_passed < 150 }
			set_timed_country_flag = { flag = fleet3dealmod2cost2 days = @fleet3dealdecay }
			set_timed_country_flag = { flag = fleet3deal1product2 days = @fleet3dealdecay }
		}
		else_if = {
			limit = { years_passed > 149 }
			set_timed_country_flag = { flag = fleet3dealmod2cost3 days = @fleet3dealdecay }
			set_timed_country_flag = { flag = fleet3deal1product3 days = @fleet3dealdecay }
		}
	}
	#Get costs for Deal 13
	if = { #Costs
		limit = {
			has_country_flag = fleet3dealmod4
			NOR = {
				has_country_flag = fleet3deal7cost1
				has_country_flag = fleet3deal7cost2
				has_country_flag = fleet3deal7cost3
			}
		}
		random_list = {
			2 = { set_timed_country_flag = { flag = fleet3deal7cost1 days = @fleet3dealdecay } }
			1 = {
				set_timed_country_flag = { flag = fleet3deal7cost2 days = @fleet3dealdecay }
				modifier = {
					factor = 0
					NOT = {
						resource_stockpile_compare = {
							resource = exotic_gases
							value > 1
						}
					}
				}
			}
			2 = { #Non-Servs will not have Consumer Goods
				modifier = {
					factor = 0
					country_uses_consumer_goods = no
				}
				set_timed_country_flag = { flag = fleet3deal7cost3 days = @fleet3dealdecay }
			}
		}
		#Get station tar for Deal 7
		random_planet_within_border = {
			limit = {
				has_mining_station = yes
				has_resource = { type = minerals amount > 0 }
				NOT = { has_modifier = racket_mineral_sniffer }
				NOT = { is_planet_class = pc_molten }
			}
			set_timed_planet_flag = { flag = fleet3deal7planetflag days = @fleet3dealdecay }
			save_event_target_as = fleet3deal7planet
		}
	}
	# Get Country for Deal Mod 7
	if = {
		limit = {
			has_country_flag = fleet3dealmod7
		}
		random_relation = {
			limit = {
				OR = { is_country_type = default is_country_type = ascended_empire is_country_type = lost_empire }
				has_communications = ROOT
				ROOT = { intel = { who = PREV value < 100 } }
			}
			weights = {
				base = 1
				modifier = {
					add = 5
					any_neighbor_country = {
						is_same_value = ROOT
					}
				}
				modifier = {
					add = 10
					OR = {
						is_rival = ROOT
						ROOT = { is_rival = PREV }
					}
				}
			}
			set_timed_country_flag = { flag = fleet3dealmod7country days = @fleet3dealdecay }
			save_event_target_as = fleet3dealmod7country
		}
	}
}

cara_execute_deal3 = {
	# Cost
	hidden_effect = {
		if = { #Deal 1 Cost 1
			limit = { has_country_flag = fleet3deal1cost1 }
			add_resource = { food = -200 }
			tooltip = { add_resource = { food = -200 } }
			remove_country_flag = fleet3deal1cost1
		}
		else_if = { #Deal 1 Cost 2
			limit = { has_country_flag = fleet3deal1cost2 }
			add_resource = { food = -1000 }
			tooltip = { add_resource = { food = -1000 } }
			remove_country_flag = fleet3deal1cost2
		}
		else_if = { #Deal 1 Cost 3
			limit = { has_country_flag = fleet3deal1cost3 }
			add_resource = { food = -4000 }
			tooltip = { add_resource = { food = -4000 } }
			remove_country_flag = fleet3deal1cost3
		}
		else_if = { #Deal 2 Cost 1
			limit = { has_country_flag = fleet3deal2cost1 }
			add_resource = { energy = -300 }
			tooltip = { add_resource = { energy = -300 } }
			remove_country_flag = fleet3deal2cost1
		}
		else_if = { #Deal 2 Cost 2
			limit = { has_country_flag = fleet3deal2cost2 }
			add_resource = { food = -200 }
			tooltip = { add_resource = { food = -200 } }
			remove_country_flag = fleet3deal2cost2
		}
		else_if = { #Deal 2 Cost 3
			limit = { has_country_flag = fleet3deal2cost3 }
			add_resource = { consumer_goods = -150 }
			tooltip = { add_resource = { consumer_goods = -150 } }
			remove_country_flag = fleet3deal2cost3
		}
		else_if = { #Deal 3 Cost
			limit = { has_country_flag = fleet3deal3 }
			add_resource = { alloys = -2000 }
			tooltip = { add_resource = { alloys = -2000 } }
			#flag removed in product
		}
		else_if = { #Deal 4 Cost 1
			limit = { has_country_flag = fleet3deal4cost1 }
			add_resource = { sr_dark_matter = -15 }
			tooltip = { add_resource = { sr_dark_matter = -15 } }
			remove_country_flag = fleet3deal4cost1
		}
		else_if = { #Deal 4 Cost 2
			limit = { has_country_flag = fleet3deal4cost2 }
			add_resource = { rare_crystals = -55 }
			tooltip = { add_resource = { rare_crystals = -55 } }
			remove_country_flag = fleet3deal4cost2
		}
		else_if = { #Deal 4 Cost 3
			limit = { has_country_flag = fleet3deal4cost3 }
			add_resource = { sr_zro = -15 }
			tooltip = { add_resource = { sr_zro = -15 } }
			remove_country_flag = fleet3deal4cost3
		}
		else_if = { #Deal 5
			limit = { has_country_flag = fleet3deal5 }
			while = {
				count = 3
				random_owned_pop = {
					limit = {
						OR = {
							is_unemployed = yes
							is_pop_category = worker
							is_pop_category = simple_drone
							is_pop_category = slave
							is_pop_category = criminal
							is_pop_category = purge
						}
					}
					weights = { #Prioritize Unemployed pops
						base = 1
						modifier = {
							factor = 100
							is_unemployed = yes
						}
					}
					kill_pop = yes
				}
			}
			if = {
				limit = { has_ethic = ethic_gestalt_consciousness }
				custom_tooltip = fleet3deal5cost_gesta_tooltip
			}
			else = { custom_tooltip = fleet3deal5cost_tooltip }
			#flag removed in product
		}
		else_if = { #Deal 6 Cost 1
			limit = { has_country_flag = fleet3deal6cost1 }
			add_resource = { energy = -1000 }
			tooltip = { add_resource = { energy = -1000 } }
			remove_country_flag = fleet3deal6cost1
		}
		else_if = { #Deal 6 Cost 2
			limit = { has_country_flag = fleet3deal6cost2 }
			add_resource = { minerals = -300 }
			tooltip = { add_resource = { minerals = -300 } }
			remove_country_flag = fleet3deal6cost2
		}
		else_if = { #Deal 6 Cost 3
			limit = {
				has_country_flag = fleet3deal6cost3
			}
			add_resource = { consumer_goods = -800 }
			tooltip = { add_resource = { consumer_goods = -800 } }
			remove_country_flag = fleet3deal6cost3
		}
		else_if = { #Deal 7 Cost 1
			limit = { has_country_flag = fleet3deal7cost1 }
			add_resource = { influence = -70 }
			tooltip = { add_resource = { influence = -70 } }
			remove_country_flag = fleet3deal7cost1
		}
		else_if = { #Deal 7 Cost 2
			limit = { has_country_flag = fleet3deal7cost2 }
			add_resource = { exotic_gases = -15 }
			tooltip = { add_resource = { exotic_gases = -15 } }
			remove_country_flag = fleet3deal7cost2
		}
		else_if = { #Deal 7 Cost 3
			limit = { has_country_flag = fleet3deal7cost3 }
			add_resource = { consumer_goods = -100 }
			tooltip = { add_resource = { consumer_goods = -100 } }
			remove_country_flag = fleet3deal7cost3
		}
		else_if = { #Deal 8 Cost 1
			limit = { has_country_flag = fleet3deal8cost1 }
			add_resource = { consumer_goods = -300 }
			tooltip = { add_resource = { consumer_goods = -300 } }
			remove_country_flag = fleet3deal8cost1
		}
		else_if = { #Deal 8 Cost 2
			limit = { has_country_flag = fleet3deal8cost2 }
			add_resource = { influence = -70 }
			tooltip = { add_resource = { influence = -70 } }
			remove_country_flag = fleet3deal8cost2
		}
		else_if = { #Deal 9
			limit = { has_country_flag = fleet3deal9 }
			add_resource = { minerals = -2000 }
			tooltip = {
				add_resource = { minerals = -2000 }
			}
			custom_tooltip = "fleet3deal9.tooltip"
			capital_scope = {
				create_fleet = {
					name = "NAME_CARAVANEER_DESTROYER_RACKET"
					effect = {
						set_owner = root
						create_ship = {
							name = "NAME_CARAVANEER_DESTROYER_RACKET"
							design = NAME_Yojimbo
							graphical_culture = "caravaneer_01"
						}
						set_location = {
							target = root.capital_scope
							distance = 10
							angle = random
						}
					}
				}
			}
		}
		else_if = { #Deal 11 Cost 1
			limit = { has_country_flag = fleet3dealmod2cost1 }
			add_resource = { alloys = -20 }
			tooltip = { add_resource = { alloys = -20 } }
			remove_country_flag = fleet3dealmod2cost1
		}
		else_if = { #Deal 11 Cost 2
			limit = { has_country_flag = fleet3dealmod2cost2 }
			add_resource = { alloys = -50 }
			tooltip = { add_resource = { alloys = -50 } }
			remove_country_flag = fleet3dealmod2cost2
		}
		else_if = { #Deal 11 Cost 3
			limit = { has_country_flag = fleet3dealmod2cost3 }
			add_resource = { alloys = -100 }
			tooltip = { add_resource = { alloys = -100 } }
			remove_country_flag = fleet3dealmod2cost3
		}
		else_if = { #Deal Mod 6
			limit = { has_country_flag = fleet3dealmod6 }
			add_resource = { energy = -3000 }
			tooltip = { add_resource = { energy = -3000 } }
		}
		else_if = { #Deal Mod 7
			limit = { has_country_flag = fleet3dealmod7 }
			add_resource = { influence = -70 }
			tooltip = { add_resource = { influence = -70 } }
		}
	}

	#Product
	hidden_effect = {
		# Deal 1 Products
		if = {
			limit = { has_country_flag = fleet3deal1product1 }
			add_resource = { minerals = 200 }
			tooltip = { add_resource = { minerals = 200 } }
			remove_country_flag = fleet3deal1product1
			remove_country_flag = fleet3deal1
			remove_country_flag = fleet3dealmod2
		}
		else_if = {
			limit = { has_country_flag = fleet3deal1product2 }
			add_resource = { minerals = 500 }
			tooltip = { add_resource = { minerals = 500 } }
			remove_country_flag = fleet3deal1product2
			remove_country_flag = fleet3deal1
			remove_country_flag = fleet3dealmod2
		}
		else_if = {
			limit = { has_country_flag = fleet3deal1product3 }
			add_resource = { minerals = 2000 }
			tooltip = { add_resource = { minerals = 2000 } }
			remove_country_flag = fleet3deal1product3
			remove_country_flag = fleet3deal1
			remove_country_flag = fleet3dealmod2
		}
		# Deal 2 Product 1: Engineer
		else_if = {
			limit = { has_country_flag = fleet3deal2product1 }
			custom_tooltip = fleet3deal2product1_tooltip
			if = { #Biological
				limit = { NOT = { has_authority = auth_machine_intelligence } }
				create_leader = {
					class = scientist
					species = event_target:racket_species
					name = random
					skill = 3
				}
				last_created_leader = {
					random_list = {
						1 = { add_trait = leader_trait_spark_of_genius }
						1 = { add_trait = leader_trait_maniacal }
						1 = { add_trait = leader_trait_expertise_materials }
						1 = { add_trait = leader_trait_expertise_propulsion }
						1 = { add_trait = leader_trait_expertise_voidcraft }
						1 = { add_trait = leader_trait_expertise_industry }
					}
				}
			}
			else_if = { #Machine
				limit = { has_authority = auth_machine_intelligence }
				create_leader = {
					class = scientist
					species = event_target:racket_robot_species
					name = random
					skill = 3
				}
				last_created_leader = {
					random_list = {
						1 = { add_trait = leader_trait_flexible_programming }
						1 = { add_trait = leader_trait_analytical }
						1 = { add_trait = leader_trait_expertise_materials }
						1 = { add_trait = leader_trait_expertise_propulsion }
						1 = { add_trait = leader_trait_expertise_voidcraft }
						1 = { add_trait = leader_trait_expertise_industry }
					}
				}
			}
			remove_country_flag = fleet3deal2product1
			remove_country_flag = fleet3deal2
		}
		# Deal 2 Product 2: Governor
		else_if = {
			limit = { has_country_flag = fleet3deal2product2 }
			custom_tooltip = fleet3deal2product2_tooltip
			if = { #Biological
				limit = { NOT = { has_authority = auth_machine_intelligence } }
				create_leader = {
					class = governor
					species = event_target:racket_species
					name = random
					skill = 3
				}
				last_created_leader = {
					add_trait = leader_trait_waste_management_specialist
				}
			}
			else_if = { #Machine
				limit = { has_authority = auth_machine_intelligence }
				create_leader = {
					class = governor
					species = event_target:racket_robot_species
					name = random
					skill = 3
				}
				last_created_leader = {
					add_trait = leader_trait_waste_management_specialist
				}
			}
			remove_country_flag = fleet3deal2product2
			remove_country_flag = fleet3deal2
		}
		# Deal 3 Product
		else_if = {
			limit = { has_country_flag = fleet3deal3 }
			if = {
				limit = { owner = { is_robot_empire = yes } }
				custom_tooltip = "fleet3deal3product_machi_tooltip"
			}
			else = {
				custom_tooltip = "fleet3deal3product_tooltip"
			}
			event_target:fleet3deal3planet = {
				if = {
					limit = { owner = { is_robot_empire = yes } }
					while = {
						count = 4
						create_pop = {
							species = event_target:racket_robot_species
						}
					}
				}
				else = {
					while = {
						count = 4
						create_pop = {
							species = event_target:racket_species
						}
					}
				}
				remove_planet_flag = fleet3deal3planet
			}
			remove_country_flag = fleet3deal3
		}
		# Deal 4 Product 1
		else_if = {
			limit = { has_country_flag = fleet3deal4product1 }
			add_resource = { alloys = 2000 }
			tooltip = { add_resource = { alloys = 2000 } }
			remove_country_flag = fleet3deal4product1
			remove_country_flag = fleet3deal4
		}
		# Deal 4 Product 2
		else_if = {
			limit = { has_country_flag = fleet3deal4product2 }
			add_resource = { exotic_gases = 150 }
			tooltip = { add_resource = { exotic_gases = 150 } }
			remove_country_flag = fleet3deal4product2
			remove_country_flag = fleet3deal4
		}
		# Deal 4 Product 3
		else_if = {
			limit = { has_country_flag = fleet3deal4product3 }
			add_resource = { sr_living_metal = 40 }
			tooltip = { add_resource = { sr_living_metal = 40 } }
			generate_lcluster_clue = yes
			tooltip = { generate_lcluster_clue = yes }
			remove_country_flag = fleet3deal4product3
			remove_country_flag = fleet3deal4
		}
		# Deal 4 Product 4
		else_if = {
			limit = { has_country_flag = fleet3deal4productmod1 }
			add_resource = { nanites = 40 }
			tooltip = { add_resource = { nanites = 40 } }
			remove_country_flag = fleet3deal4productmod1
			remove_country_flag = fleet3deal4
		}
		# Deal 5
		else_if = {
			limit = { has_country_flag = fleet3deal5 }
			set_country_flag = bought_waste_reprocessing_center
			custom_tooltip = fleet3deal5product_tooltip
			remove_country_flag = fleet3deal5
		}
		# Deal 6
		else_if = {
			limit = { has_country_flag = fleet3deal6 }
			give_technology = { tech = tech_orbital_trash_dispersal }
			tooltip = { give_technology = { tech = tech_orbital_trash_dispersal } }
			remove_country_flag = fleet3deal6
		}
		# Deal 7
		else_if = {
			limit = { has_country_flag = fleet3deal7 }
			if = {
				limit = { NOT = { exists = event_target:fleet3deal7planet } }
				random_planet_within_border = {
					limit = {
						has_mining_station = yes
						has_resource = { type = minerals amount > 0 }
						NOT = { has_modifier = racket_mineral_sniffer }
						NOT = { is_planet_class = pc_molten }
					}
					set_timed_planet_flag = { flag = fleet3deal7planetflag days = @fleet3dealdecay }
					save_event_target_as = fleet3deal7planet
				}
			}
			event_target:fleet3deal7planet = {
				add_deposit = d_energy_5
				add_modifier = {
					modifier = "racket_energy_extractor"
					days = -1
				}
				remove_planet_flag = fleet3deal7planetflag
			}
			tooltip = {
				event_target:fleet3deal7planet = {
					add_deposit = d_energy_5
				}
			}
			if = {
				limit = { NOT = { has_country_flag = got_fleet3deal7 } }
				set_country_flag = got_fleet3deal7
			}
			remove_country_flag = fleet3deal7
		}
		# Deal 8
		else_if = {
			limit = { has_country_flag = fleet3deal8 }
			event_target:fleet3deal8planet = {
				add_modifier = {
					modifier = "racket_generator_regulator"
					days = -1
				}
				remove_planet_flag = fleet3deal8planet
			}
			tooltip = {
				event_target:fleet3deal8planet = {
					add_modifier = {
						modifier = "racket_generator_regulator"
						days = -1
					}
				}
			}
			set_country_flag = got_fleet3deal8
			remove_country_flag = fleet3deal8
		}
		#Deal Mod 1
		else_if = {
			limit = { has_country_flag = fleet3dealmod1 }
			add_modifier = {
				modifier = "fleet3_munitions"
				days = 9000 # 25 years
			}
			remove_country_flag = fleet3dealmod1
			tooltip = {
				add_modifier = {
					modifier = "fleet3_munitions"
					days = 9000 # 25 years
				}
			}
		}
		#Deal Mod 3
		else_if = {
			limit = { has_country_flag = fleet3dealmod3 }
			collector_surrenders_artifact = yes
			custom_tooltip = fleet1productmod3_tooltip
			remove_country_flag = fleet3dealmod3
			set_country_flag = fleet3_precursor
		}
		#Deal Mod 4
		else_if = {
			limit = { has_country_flag = fleet3dealmod4 }
			event_target:fleet3deal7planet = {
				add_deposit = d_minerals_1
				add_deposit = d_alloys_2
				add_modifier = {
					modifier = "racket_mineral_sniffer"
					days = -1
				}
				random_list = {
					100 = { } # no additional deposits
					10 = { add_deposit = d_minerals_2 }
					7 = { add_deposit = d_minerals_3 }
					5 = { add_deposit = d_minerals_4 }
					10 = { add_deposit = d_alloys_1 }
					5 = { add_deposit = d_alloys_2 }
					4 = {
						add_deposit = d_rare_crystals_1
						modifier = {
							factor = 0
							ROOT = { NOT = { has_technology = tech_mine_rare_crystals } }
						}
					}
					2 = {
						add_deposit = d_rare_crystals_2
						modifier = {
							factor = 0
							ROOT = { NOT = { has_technology = tech_mine_rare_crystals } }
						}
					}
					4 = {
						add_deposit = d_volatile_motes_1
						modifier = {
							factor = 0
							ROOT = { NOT = { has_technology = tech_mine_volatile_motes } }
						}
					}
					2 = {
						add_deposit = d_volatile_motes_2
						modifier = {
							factor = 0
							ROOT = { NOT = { has_technology = tech_mine_volatile_motes } }
						}
					}
					1 = {
						add_deposit = d_zro_deposit_1
						modifier = {
							factor = 0
							ROOT = { NOT = { has_technology = tech_mine_zro } }
						}
					}
					1 = {
						add_deposit = d_living_metal_deposit
						modifier = {
							factor = 0
							ROOT = { NOT = { has_technology = tech_mine_living_metal } }
						}
					}
				}
				remove_planet_flag = fleet3deal7planetflag
			}
			tooltip = {
				event_target:fleet3deal7planet = {
					add_deposit = d_minerals_1
					add_deposit = d_alloys_2
				}
			}
			custom_tooltip = fleet3dealmod4tooltip
			if = {
				limit = { NOT = { has_country_flag = got_fleet3dealmod4 } }
				set_country_flag = got_fleet3dealmod4
			}
			remove_country_flag = fleet3dealmod4
		}
		#Deal Mod 5
		else_if = {
			limit = { has_country_flag = fleet3dealmod5 }
			add_resource = { minor_artifacts = 5 }
			tooltip = {
				add_resource = { minor_artifacts = 5 }
			}
			remove_country_flag = fleet3dealmod5
		}
		# Deal Mod 6
		else_if = {
			limit = { has_country_flag = fleet3dealmod6 }
			add_modifier = {
				modifier = fleet3_scavengers
				days = 28800 # 80 years
			}
			tooltip = {
				add_modifier = {
					modifier = fleet3_scavengers
					days = 28800 # 80 years
				}
			}
			remove_country_flag = fleet3dealmod6
		}
		# Deal Mod 7
		else_if = {
			limit = { has_country_flag = fleet3dealmod7 }
			add_intel = { amount = 15 who = event_target:fleet3dealmod7country }
			tooltip = {
				add_intel = { amount = 15 who = event_target:fleet3dealmod7country }
			}
			remove_country_flag = fleet3dealmod7
		}
	}
}