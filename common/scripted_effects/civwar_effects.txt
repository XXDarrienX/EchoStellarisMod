
###############################
### Civil Wars by MrFunEGUY ###
###############################
# 
# Get Empire Sprawl Percentage
get_empire_sprawl = {
	export_trigger_value_to_variable = {
		trigger = empire_sprawl
		variable = total_empire_sprawl_hold
	}
	export_trigger_value_to_variable = {
		trigger = empire_sprawl
		variable = total_empire_sprawl_original
	}
	export_trigger_value_to_variable = {
		trigger = empire_sprawl
		variable = total_empire_sprawl
	}
	export_trigger_value_to_variable = {
		trigger = empire_sprawl_over_cap
		variable = total_empire_sprawl_over_cap
	}
	if = {
		limit = {
			check_variable = {
				which = total_empire_sprawl_over_cap
				value > 0
			}
		}
		subtract_variable = {
			which = total_empire_sprawl
			value = total_empire_sprawl_over_cap
		}
		divide_variable = {
			which = total_empire_sprawl_original
			value = total_empire_sprawl
		}
		multiply_variable = {
			which = total_empire_sprawl_original
			value = total_empire_sprawl_over_cap
		}
		divide_variable = {
			which = total_empire_sprawl_original
			value = total_empire_sprawl_hold
		}
		set_variable = {
			which = empire_sprawl_cap_percentage
			value = total_empire_sprawl_original
		}
		if = {
			limit = {
				check_variable = {
					which = empire_sprawl_cap_percentage
					value > 0
				}
				check_variable = {
					which = empire_sprawl_cap_percentage
					value < 0.1
				}
			}
			set_country_flag = empire_sprawl_0_10
		}
		else_if = {
			limit = {
				check_variable = {
					which = empire_sprawl_cap_percentage
					value >= 0.1
				}
				check_variable = {
					which = empire_sprawl_cap_percentage
					value < 0.2
				}
			}
			set_country_flag = empire_sprawl_10_20
		}
		else_if = {
			limit = {
				check_variable = {
					which = empire_sprawl_cap_percentage
					value >= 0.2
				}
				check_variable = {
					which = empire_sprawl_cap_percentage
					value < 0.3
				}
			}
			set_country_flag = empire_sprawl_20_30
		}
		else_if = {
			limit = {
				check_variable = {
					which = empire_sprawl_cap_percentage
					value >= 0.3
				}
				check_variable = {
					which = empire_sprawl_cap_percentage
					value < 0.4
				}
			}
			set_country_flag = empire_sprawl_30_40
		}
		else_if = {
			limit = {
				check_variable = {
					which = empire_sprawl_cap_percentage
					value >= 0.4
				}
				check_variable = {
					which = empire_sprawl_cap_percentage
					value < 0.5
				}
			}
			set_country_flag = empire_sprawl_40_50
		}
		else_if = {
			limit = {
				check_variable = {
					which = empire_sprawl_cap_percentage
					value >= 0.5
				}
				check_variable = {
					which = empire_sprawl_cap_percentage
					value < 0.6
				}
			}
			set_country_flag = empire_sprawl_50_60
		}
		else_if = {
			limit = {
				check_variable = {
					which = empire_sprawl_cap_percentage
					value >= 0.6
				}
				check_variable = {
					which = empire_sprawl_cap_percentage
					value < 0.7
				}
			}
			set_country_flag = empire_sprawl_60_70
		}
		else_if = {
			limit = {
				check_variable = {
					which = empire_sprawl_cap_percentage
					value >= 0.7
				}
				check_variable = {
					which = empire_sprawl_cap_percentage
					value < 0.8
				}
			}
			set_country_flag = empire_sprawl_70_80
		}
		else_if = {
			limit = {
				check_variable = {
					which = empire_sprawl_cap_percentage
					value >= 0.8
				}
				check_variable = {
					which = empire_sprawl_cap_percentage
					value < 0.9
				}
			}
			set_country_flag = empire_sprawl_80_90
		}
		else_if = {
			limit = {
				check_variable = {
					which = empire_sprawl_cap_percentage
					value >= 0.9
				}
				check_variable = {
					which = empire_sprawl_cap_percentage
					value < 1
				}
			}
			set_country_flag = empire_sprawl_90_100
		}
		else_if = {
			limit = {
				check_variable = {
					which = empire_sprawl_cap_percentage
					value >= 1
				}
			}
			set_country_flag = empire_sprawl_100_plus
		}
	}
	else = {
		set_country_flag = empire_sprawl_0
	}
}

#####################

# Effect for Traitor's new country
set_traitor_country_flag = {
	if = {
		limit = {
			NOT = { has_country_flag = traitor_country_1_@root }
		}
		set_country_flag = traitor_country_1_@root
	}
	else_if = {
		limit = {
			NOT = { has_country_flag = traitor_country_2_@root }
		}
		set_country_flag = traitor_country_2_@root
	}
	else_if = {
		limit = {
			NOT = { has_country_flag = traitor_country_3_@root }
		}
		set_country_flag = traitor_country_3_@root
	}
	else_if = {
		limit = {
			NOT = { has_country_flag = traitor_country_4_@root }
		}
		set_country_flag = traitor_country_4_@root
	}
	else_if = {
		limit = {
			NOT = { has_country_flag = traitor_country_5_@root }
		}
		set_country_flag = traitor_country_5_@root
	}
}

# Effect for Traitor leader
set_traitor_flag = {
	if = {
		limit = {
			prev = {
				has_country_flag = traitor_country_1_@root
			}
		}
		set_leader_flag = traitor_1_@prev
	}
	else_if = {
		limit = {
			prev = {
				has_country_flag = traitor_country_2_@root
			}
		}
		set_leader_flag = traitor_2_@prev
	}
	else_if = {
		limit = {
			prev = {
				has_country_flag = traitor_country_3_@root
			}
		}
		set_leader_flag = traitor_3_@prev
	}
	else_if = {
		limit = {
			prev = {
				has_country_flag = traitor_country_4_@root
			}
		}
		set_leader_flag = traitor_4_@prev
	}
	else_if = {
		limit = {
			prev = {
				has_country_flag = traitor_country_5_@root
			}
		}
		set_leader_flag = traitor_5_@prev
	}
}

# Effect for Traitor's mother country
set_traitor_country_flag_mother = {
	if = {
		limit = {
			prev = {
				has_country_flag = traitor_country_1_@root
			}
		}
		set_country_flag = traitor_country_mother_1_@prev
	}
	else_if = {
		limit = {
			prev = {
				has_country_flag = traitor_country_2_@root
			}
		}
		set_country_flag = traitor_country_mother_2_@prev
	}
	else_if = {
		limit = {
			prev = {
				has_country_flag = traitor_country_3_@root
			}
		}
		set_country_flag = traitor_country_mother_3_@prev
	}
	else_if = {
		limit = {
			prev = {
				has_country_flag = traitor_country_4_@root
			}
		}
		set_country_flag = traitor_country_mother_4_@prev
	}
	else_if = {
		limit = {
			prev = {
				has_country_flag = traitor_country_5_@root
			}
		}
		set_country_flag = traitor_country_mother_5_@prev
	}
}

#####################

# Effect for Heir traitor's new country
set_heir_traitor_country_flag = {
	if = {
		limit = {
			NOT = { has_country_flag = heir_traitor_1_@root }
		}
		set_country_flag = heir_traitor_country_1_@root
	}
	else_if = {
		limit = {
			NOT = { has_country_flag = heir_traitor_2_@root }
		}
		set_country_flag = heir_traitor_country_2_@root
	}
	else_if = {
		limit = {
			NOT = { has_country_flag = heir_traitor_3_@root }
		}
		set_country_flag = heir_traitor_country_3_@root
	}
	else_if = {
		limit = {
			NOT = { has_country_flag = heir_traitor_4_@root }
		}
		set_country_flag = heir_traitor_country_4_@root
	}
	else_if = {
		limit = {
			NOT = { has_country_flag = heir_traitor_5_@root }
		}
		set_country_flag = heir_traitor_country_5_@root
	}
}

# Effect for Heir traitor leader
set_heir_traitor_flag = {
	if = {
		limit = {
			prev = {
				has_country_flag = heir_traitor_country_1_@root
			}
		}
		set_leader_flag = heir_traitor_1_@prev
	}
	else_if = {
		limit = {
			prev = {
				has_country_flag = heir_traitor_country_2_@root
			}
		}
		set_leader_flag = heir_traitor_2_@prev
	}
	else_if = {
		limit = {
			prev = {
				has_country_flag = heir_traitor_country_3_@root
			}
		}
		set_leader_flag = heir_traitor_3_@prev
	}
	else_if = {
		limit = {
			prev = {
				has_country_flag = heir_traitor_country_4_@root
			}
		}
		set_leader_flag = heir_traitor_4_@prev
	}
	else_if = {
		limit = {
			prev = {
				has_country_flag = heir_traitor_country_5_@root
			}
		}
		set_leader_flag = heir_traitor_5_@prev
	}
}

# Effect for Heir traitor's mother country
set_heir_traitor_country_flag_mother = {
	if = {
		limit = {
			prev = {
				has_country_flag = heir_traitor_country_1_@root
			}
		}
		set_country_flag = heir_traitor_country_mother_1_@prev
	}
	else_if = {
		limit = {
			prev = {
				has_country_flag = heir_traitor_country_2_@root
			}
		}
		set_country_flag = heir_traitor_country_mother_2_@prev
	}
	else_if = {
		limit = {
			prev = {
				has_country_flag = heir_traitor_country_3_@root
			}
		}
		set_country_flag = heir_traitor_country_mother_3_@prev
	}
	else_if = {
		limit = {
			prev = {
				has_country_flag = heir_traitor_country_4_@root
			}
		}
		set_country_flag = heir_traitor_country_mother_4_@prev
	}
	else_if = {
		limit = {
			prev = {
				has_country_flag = heir_traitor_country_5_@root
			}
		}
		set_country_flag = heir_traitor_country_mother_5_@prev
	}
}

#####################

# Effect for heir's dummy country and mother country
get_heir_connection = {
	from = {
		if = {
			limit = {
				has_leader_flag = ruler_heir_connection_@event_target:disinherited_heir_country_1
			}
			event_target:disinherited_heir_country_1 = { save_global_event_target_as = heir_civil_war_dummy_country }
		}
		else_if = {
			limit = {
				has_leader_flag = ruler_heir_connection_@event_target:disinherited_heir_country_2
			}
			event_target:disinherited_heir_country_2 = { save_global_event_target_as = heir_civil_war_dummy_country }
		}
		else_if = {
			limit = {
				has_leader_flag = ruler_heir_connection_@event_target:disinherited_heir_country_3
			}
			event_target:disinherited_heir_country_3 = { save_global_event_target_as = heir_civil_war_dummy_country }
		}
		else_if = {
			limit = {
				has_leader_flag = ruler_heir_connection_@event_target:disinherited_heir_country_4
			}
			event_target:disinherited_heir_country_4 = { save_global_event_target_as = heir_civil_war_dummy_country }
		}
		else_if = {
			limit = {
				has_leader_flag = ruler_heir_connection_@event_target:disinherited_heir_country_5
			}
			event_target:disinherited_heir_country_5 = { save_global_event_target_as = heir_civil_war_dummy_country }
		}
		else_if = {
			limit = {
				has_leader_flag = ruler_heir_connection_@event_target:disinherited_heir_country_6
			}
			event_target:disinherited_heir_country_6 = { save_global_event_target_as = heir_civil_war_dummy_country }
		}
		else_if = {
			limit = {
				has_leader_flag = ruler_heir_connection_@event_target:disinherited_heir_country_7
			}
			event_target:disinherited_heir_country_7 = { save_global_event_target_as = heir_civil_war_dummy_country }
		}
		else_if = {
			limit = {
				has_leader_flag = ruler_heir_connection_@event_target:disinherited_heir_country_8
			}
			event_target:disinherited_heir_country_8 = { save_global_event_target_as = heir_civil_war_dummy_country }
		}
		else_if = {
			limit = {
				has_leader_flag = ruler_heir_connection_@event_target:disinherited_heir_country_9
			}
			event_target:disinherited_heir_country_9 = { save_global_event_target_as = heir_civil_war_dummy_country }
		}
		else_if = {
			limit = {
				has_leader_flag = ruler_heir_connection_@event_target:disinherited_heir_country_10
			}
			event_target:disinherited_heir_country_10 = { save_global_event_target_as = heir_civil_war_dummy_country }
		}
	}
}

# Effect for tying heir's dummy country and mother country
set_heir_country_flag = {
	if = {
		limit = {
			NOT = { exists = event_target:disinherited_heir_country_1 }
		}
		save_global_event_target_as = disinherited_heir_country_1
		event_target:heir_mother_country = {
			ruler = {
				set_leader_flag = ruler_heir_connection_@event_target:disinherited_heir_country_1
			}
		}
	}
	else_if = {
		limit = {
			NOT = { exists = event_target:disinherited_heir_country_2 }
		}
		save_global_event_target_as = disinherited_heir_country_2
		event_target:heir_mother_country = {
			ruler = {
				set_leader_flag = ruler_heir_connection_@event_target:disinherited_heir_country_2
			}
		}
	}
	else_if = {
		limit = {
			NOT = { exists = event_target:disinherited_heir_country_3 }
		}
		save_global_event_target_as = disinherited_heir_country_3
		event_target:heir_mother_country = {
			ruler = {
				set_leader_flag = ruler_heir_connection_@event_target:disinherited_heir_country_3
			}
		}
	}
	else_if = {
		limit = {
			NOT = { exists = event_target:disinherited_heir_country_4 }
		}
		save_global_event_target_as = disinherited_heir_country_4
		event_target:heir_mother_country = {
			ruler = {
				set_leader_flag = ruler_heir_connection_@event_target:disinherited_heir_country_4
			}
		}
	}
	else_if = {
		limit = {
			NOT = { exists = event_target:disinherited_heir_country_5 }
		}
		save_global_event_target_as = disinherited_heir_country_5
		 save_global_event_target_as = heir_civil_war_dummy_country 
		event_target:heir_mother_country = {
			ruler = {
				set_leader_flag = ruler_heir_connection_@event_target:disinherited_heir_country_5
			}
		}
	}
	else_if = {
		limit = {
			NOT = { exists = event_target:disinherited_heir_country_6 }
		}
		save_global_event_target_as = disinherited_heir_country_6 
		event_target:heir_mother_country = {
			ruler = {
				set_leader_flag = ruler_heir_connection_@event_target:disinherited_heir_country_6 
			}
		}
	}
	else_if = {
		limit = {
			NOT = { exists = event_target:disinherited_heir_country_7 }
		}
		save_global_event_target_as = disinherited_heir_country_7
		event_target:heir_mother_country = {
			ruler = {
				set_leader_flag = ruler_heir_connection_@event_target:disinherited_heir_country_7
			}
		}
	}
	else_if = {
		limit = {
			NOT = { exists = event_target:disinherited_heir_country_8 }
		}
		save_global_event_target_as = disinherited_heir_country_8
		event_target:heir_mother_country = {
			ruler = {
				set_leader_flag = ruler_heir_connection_@event_target:disinherited_heir_country_8
			}
		}
	}
	else_if = {
		limit = {
			NOT = { exists = event_target:disinherited_heir_country_9 }
		}
		save_global_event_target_as = disinherited_heir_country_9
		event_target:heir_mother_country = {
			ruler = {
				set_leader_flag = ruler_heir_connection_@event_target:disinherited_heir_country_9
			}
		}
	}
	else_if = {
		limit = {
			NOT = { exists = event_target:disinherited_heir_country_10 }
		}
		save_global_event_target_as = disinherited_heir_country_10
		event_target:heir_mother_country = {
			ruler = {
				set_leader_flag = ruler_heir_connection_@event_target:disinherited_heir_country_10
			}
		}
	}
}

#####################

# Set Installed Leader Setup
set_installed_heir_gov = {
	if = {
		limit = {
			NOR = {
				has_authority = auth_imperial
				has_authority = auth_corporate_imperial
				has_authority = auth_corporate_fiefdom
			}
		}
		change_government = {
			authority = auth_imperial
			cooldown = no
			remove_invalid_civics = yes
		}
	}
	set_leader = event_target:traitor_leader
	ruler = {
		set_leader_flag = grateful_restored_leader_@this
	}
	add_opinion_modifier = {
		who = prev
		modifier = opinion_restored_to_leadership
	}
}

# Set Installed Heir Setup
set_installed_traitor_gov = {
	log = "installer runnung"
	if = {
		limit = {
			NOR = {
				has_authority = auth_imperial
				has_authority = auth_dictatorial
				has_authority = auth_corporate_imperial
				has_authority = auth_corporate_fiefdom
			}
		}
		change_government = {
			authority = auth_dictatorial
			cooldown = no
			remove_invalid_civics = yes
		}
	}
	set_leader = event_target:traitor_leader
	ruler = {
		set_leader_flag = grateful_restored_leader_@this
	}
	add_opinion_modifier = {
		who = prev
		modifier = opinion_restored_to_leadership
	}
}

#####################

# Get Sector
get_random_sector_for_civwar = {
	random_owned_sector = {
		limit = {
			has_sector_type = normal_sector
			NOT = { has_sector_flag = rebel_sector }
        }
        set_sector_flag = rebel_sector
	    every_system_within_border = {
            limit = {
                NOT = {
                	any_system_planet = {
                		is_capital = yes
                		owner = { is_primitive = no }
                	}
                }
            }
            set_star_flag = civil_war_flip
        }
	}
}

# Get relatively random amount of all sectors
get_sectors_and_multiply = {
	every_owned_sector = {
		limit = {
			has_sector_type = normal_sector
			NOT = { has_sector_flag = rebel_sector }
		}
		root = { change_variable = { which = total_sectors value = 1 } }
	}

	random_list = {
		25 = {
			multiply_variable = {
				which = total_sectors
				value = 0.25
			}
		}
		10 = {
			multiply_variable = {
				which = total_sectors
				value = 0.30
			}
		}
		10 = {
			multiply_variable = {
				which = total_sectors
				value = 0.40
			}
		}
		30 = {
			multiply_variable = {
				which = total_sectors
				value = 0.50
			}
		}
		10 = {
			multiply_variable = {
				which = total_sectors
				value = 0.60
			}
		}
		10 = {
			multiply_variable = {
				which = total_sectors
				value = 0.70
			}
		}
		5 = {
			multiply_variable = {
				which = total_sectors
				value = 0.75
			}
		}
	}

	round_variable = total_sectors
}

#####################

# Get rid of "Rebels of x" on Galactic Map
get_rid_rebels_of_originator = {
	hidden_effect = {
		event_target:current_civwar_rebels = {
			set_subject_of = {
				who = event_target:current_civwar_originator
				subject_type = dummy_vassal
			}
		}
		event_target:current_civwar_rebels = {
			set_subject_of = {
				who = none
			}
		}
	}
}

# Get rid of "Rebels of x" on Galactic Map
get_rid_rebels_of_root = {
	hidden_effect = {
		event_target:current_civwar_rebels = {
			set_subject_of = {
				who = root
				subject_type = dummy_vassal
			}
		}
		event_target:current_civwar_rebels = {
			set_subject_of = {
				who = none
			}
		}
	}
}

#####################

# Get civil war faction
get_civil_war_faction = {
	# Faction Leader Rebellion - Authoritarian
	if = {
		limit = {
			event_target:civil_war_party = {
		        is_pop_faction_type = totalitarian
			}
		}
		else = {
			country_event = { id = civwarcountry.1004 }
		}
	}
	# Faction Leader Rebellion - Egalitarian
	else_if = {
		limit = {
			event_target:civil_war_party = {
		        is_pop_faction_type = progressive
			}
		}
		else = {
			country_event = { id = civwarcountry.1005 }
		}
	}
	# Faction Leader Rebellion - Militarist
	else_if = {
		limit = {
			event_target:civil_war_party = {
		        is_pop_faction_type = imperialist
			}
		}
		else = {
			country_event = { id = civwarcountry.1006 }
		}
	}
	# Faction Leader Rebellion - Pacifist
	else_if = {
		limit = {
			event_target:civil_war_party = {
		        is_pop_faction_type = prosperity
			}
		}
		else = {
			country_event = { id = civwarcountry.1007 }
		}
	}
	# Faction Leader Rebellion - Materialist
	else_if = {
		limit = {
			event_target:civil_war_party = {
		        is_pop_faction_type = technologist
			}
		}
		else = {
			country_event = { id = civwarcountry.1008 }
		}
	}
	# Faction Leader Rebellion - Spiritualist
	else_if = {
		limit = {
			event_target:civil_war_party = {
        		is_pop_faction_type = traditionalist
			}
		}
		else = {
			country_event = { id = civwarcountry.1009 }
		}
	}
	# Faction Leader Rebellion - Xenophilic
	else_if = {
		limit = {
			event_target:civil_war_party = {
        		is_pop_faction_type = xenoist
			}
		}
		else = {
			country_event = { id = civwarcountry.1010 }
		}
	}
	# Faction Leader Rebellion - Xenophobic
	else_if = {
		limit = {
			event_target:civil_war_party = {
		        OR = {
        			is_pop_faction_type = supremacist
        			is_pop_faction_type = isolationist
				}
			}
		}
		else = {
			country_event = { id = civwarcountry.1011 }
		}
	}
}